<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theater Callboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        .gold-text { color: #D4AF37; }
        .gold-border { border-color: #D4AF37; }
        .gold-bg { background-color: #D4AF37; }
        .gold-bg-hover:hover { background-color: #b89b31; }

        .card {
            background-color: #1E1E1E;
            border: 1px solid #333;
            border-radius: 8px;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #2a2a2a;
            border: 1px solid #D4AF37;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1E1E1E;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #D4AF37;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-black to-[#1a1a1a]">
        <div class="w-full max-w-md p-8 space-y-8 card">
            <div class="text-center">
                <h1 class="font-playfair text-4xl font-bold gold-text">Theater Callboard</h1>
                <p id="connection-status" class="text-red-500 font-semibold mt-2 hidden">Connection failed. Please refresh.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Name</label>
                    <input id="name" name="name" type="text" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37]">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                    <input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37]">
                </div>
                 <p id="login-error" class="text-red-500 text-sm text-center"></p>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-black gold-bg gold-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#D4AF37] transition-colors">Sign In</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-app" class="hidden">
        <header class="bg-[#1E1E1E] shadow-lg border-b-2 gold-border">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="font-playfair text-3xl font-bold gold-text">Virtual Callboard</h1>
                <div class="text-right">
                    <p class="font-bold text-white text-lg" id="user-name"></p>
                    <p class="text-sm gold-text" id="user-role"></p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- Left Column: Attendance and Calls -->
            <div class="md:col-span-2 space-y-8">
                <!-- Attendance -->
                <section id="attendance-section" class="card p-6">
                    <h2 class="font-playfair text-2xl font-bold gold-text mb-4">Rehearsal Sign-In</h2>
                    
                    <!-- Actor Sign-In View -->
                    <div id="actor-rehearsal-signin-view" class="">
                        <div id="signin-code-display" class="text-center mb-4 hidden">
                             <p class="text-gray-400">Today's Sign-In Code:</p>
                             <p id="daily-code" class="text-4xl font-bold tracking-widest text-white"></p>
                        </div>
                        <div id="signin-code-timer" class="text-center mb-4 hidden">
                            <p class="text-gray-400">Sign-in code will appear at:</p>
                            <p id="code-appearance-time" class="text-2xl font-bold text-white"></p>
                        </div>

                        <div class="flex items-center justify-center space-x-2">
                             <input type="text" id="signin-code-input" class="w-48 text-center px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#D4AF37]" placeholder="Enter Code">
                             <button id="submit-signin-code" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-black gold-bg gold-bg-hover">Sign In</button>
                        </div>
                         <p id="signin-status" class="text-center mt-3 font-semibold text-gray-400"></p>
                    </div>

                    <!-- SM/Director View -->
                    <div id="sm-director-attendance-view" class="hidden">
                        <div class="flex items-center space-x-4 mb-4">
                            <button id="force-show-code-button" class="flex-grow py-2 px-4 border gold-border rounded-md shadow-sm text-sm font-bold gold-text hover:bg-[#D4AF37] hover:text-black transition-colors">Force Show Code</button>
                            <button id="export-attendance-button" class="flex-grow py-2 px-4 border gold-border rounded-md shadow-sm text-sm font-bold gold-text hover:bg-[#D4AF37] hover:text-black transition-colors">Export Attendance</button>
                         </div>
                        <div id="attendance-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </section>

                <!-- Calls -->
                <section class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-playfair text-2xl font-bold gold-text">Calls</h2>
                        <button id="add-call-button" class="py-1 px-3 border gold-border rounded-md shadow-sm text-xs font-bold gold-text hover:bg-[#D4AF37] hover:text-black transition-colors hidden">+</button>
                    </div>
                    <div id="calls-list" class="space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </section>
            </div>

            <!-- Right Column: Announcements and Behavior -->
            <div class="space-y-8">
                 <!-- Announcements -->
                <section class="card p-6">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="font-playfair text-2xl font-bold gold-text">Announcements</h2>
                        <button id="add-announcement-button" class="py-1 px-3 border gold-border rounded-md shadow-sm text-xs font-bold gold-text hover:bg-[#D4AF37] hover:text-black transition-colors hidden">+</button>
                    </div>
                    <div id="announcements-list" class="space-y-3">
                        <!-- JS will populate this -->
                    </div>
                </section>

                <!-- Behavior Markers -->
                <section class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-playfair text-2xl font-bold gold-text">Behavior Markers</h2>
                        <button id="add-behavior-button" class="py-1 px-3 border gold-border rounded-md shadow-sm text-xs font-bold gold-text hover:bg-[#D4AF37] hover:text-black transition-colors hidden">+</button>
                    </div>
                    <div id="behaviors-list" class="space-y-3">
                       <!-- JS will populate this -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Announcement Modal -->
    <div id="announcement-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="modal-content w-full max-w-lg p-6 rounded-lg shadow-xl">
            <h3 class="font-playfair text-xl font-bold gold-text mb-4">New Announcement</h3>
            <form id="announcement-form">
                <textarea id="announcement-text" class="w-full h-32 px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white" placeholder="Type your announcement..." required></textarea>
                <div class="mt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('announcement-modal')" class="py-2 px-4 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-md text-sm font-bold text-black gold-bg gold-bg-hover">Post</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Call Modal -->
    <div id="call-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="modal-content w-full max-w-2xl p-6 rounded-lg shadow-xl">
            <h3 class="font-playfair text-xl font-bold gold-text mb-4">New Call</h3>
            <form id="call-form" class="space-y-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-300">Date</label>
                    <input type="date" id="call-date" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white">
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Call Time (Arrival)</label>
                        <input type="time" id="call-time" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Rehearsal Start Time</label>
                        <input type="time" id="call-rehearsal-time" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Description</label>
                    <textarea id="call-description" rows="2" class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white" required></textarea>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Who is Called</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-48 overflow-y-auto p-2 border border-gray-600 rounded-md">
                        <div id="call-groups-container"></div>
                        <div id="call-individuals-container" class="md:col-span-3"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('call-modal')" class="py-2 px-4 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-md text-sm font-bold text-black gold-bg gold-bg-hover">Create Call</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Behavior Modal -->
    <div id="behavior-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="modal-content w-full max-w-lg p-6 rounded-lg shadow-xl">
             <h3 class="font-playfair text-xl font-bold gold-text mb-4">New Behavior Marker</h3>
             <form id="behavior-form" class="space-y-4">
                 <div>
                     <label class="block text-sm font-medium text-gray-300">Person</label>
                     <select id="behavior-user-select" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white"></select>
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-300">Type</label>
                     <select id="behavior-type-select" required class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white">
                         <option value="Positive">Positive</option>
                         <option value="Negative">Negative</option>
                     </select>
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-300">Reason</label>
                     <textarea id="behavior-reason" rows="3" class="mt-1 block w-full px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white" required></textarea>
                 </div>
                 <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('behavior-modal')" class="py-2 px-4 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-md text-sm font-bold text-black gold-bg gold-bg-hover">Add Marker</button>
                </div>
             </form>
        </div>
    </div>
    
    <!-- Reason Modal -->
    <div id="reason-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="modal-content w-full max-w-lg p-6 rounded-lg shadow-xl">
            <h3 id="reason-modal-title" class="font-playfair text-xl font-bold gold-text mb-4">Reason</h3>
            <form id="reason-form">
                <textarea id="reason-input" class="w-full h-24 px-3 py-2 bg-[#2a2a2a] border border-gray-600 rounded-md text-white" placeholder="Enter reason..."></textarea>
                <div class="mt-4 flex justify-end space-x-3">
                     <button type="button" onclick="closeModal('reason-modal')" class="py-2 px-4 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-md text-sm font-bold text-black gold-bg gold-bg-hover">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, query, orderBy, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAACv92bzY5cECbECBtsw6oyxrUnEBaJMY",
            authDomain: "pg-theater-call-board.firebaseapp.com",
            projectId: "pg-theater-call-board",
            storageBucket: "pg-theater-call-board.firebasestorage.app",
            messagingSenderId: "850857757575",
            appId: "1:850857757575:web:8ef2834994186fabaea122",
            measurementId: "G-1DNV9KENSJ"
        };


        // --- FIREBASE INITIALIZATION ---
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            console.log("Firebase connected and user signed in anonymously.");
        } catch (error) {
            console.error("Firebase initialization or anonymous sign-in failed:", error);
            document.getElementById('connection-status').classList.remove('hidden');
        }

        // --- DATA AND STATE ---
        const users = {
            'lnewton': { role: 'Director', password: '?2@2yzz~PVJf' }, 'tbeck': { role: 'AD/Coreography', password: 'pHR68Db.Pw.#' }, 'gloshe': { role: 'Tech Director', password: 'iT=hy!7G9NTf' }, 'bflieder': { role: 'ATD/Hair Guru', password: '-W9m=>D_AUzF' }, 'cclark': { role: 'SATD', password: 'iJ+va7>Df}#@' }, 'ljulien': { role: 'Stage Manager', password: ';3y2Paz9£9?m' }, 'hflowers': { role: 'Stage Manager', password: 'i£08um?B51.x' }, 'nwalker': { role: 'Stage Manager', password: '9^1~R7C*QVdV' }, 'apate': { role: 'Actor', password: 'y~D+V3R-37Wt' }, 'cbeck': { role: 'Actor', password: 'G?5sLRCkZYCg' }, 'sjulien': { role: 'Actor', password: '#0Y57gk*b?Jq' }, 'agipson': { role: 'Actor', password: 'c!?xGW2JvB:2' }, 'owyatt': { role: 'Actor', password: '9vq-B#4q]}>.' }, 'swyatt': { role: 'Actor', password: 'B?2jjtvNqtq_' }, 'afry': { role: 'Actor', password: '5Mxc,kQpd,!T' }, 'rromero': { role: 'Actor', password: '=4A*pq+xQq:!' }, 'gromero': { role: 'Actor', password: 'j.dab8,6X_m2' }, 'adalton': { role: 'Actor', password: 'N.K#K9K.F60W' }, 'afooter': { role: 'Tech', password: '3g0w]*Lt>~]D' }, 'acollins': { role: 'Actor', password: 'MU?#03xg.GQw' }, 'achasteen': { role: 'Actor', password: '1k#VK*b~!yWA' }, 'agibson': { role: 'Actor', password: '64KmMFCb>C.y' }, 'aaslin': { role: 'Tech', password: 'YMDke#Pj23sV' }, 'abobo': { role: 'Actor', password: '=#.C_R.CLu1C' }, 'bfrazier': { role: 'Actor', password: ']r)i]-]%6*1v' }, 'bdavis': { role: 'Tech', password: 'h)~3c4^@9oow' }, 'bbenich': { role: 'Actor', password: 'q!o)%+h@Fz7-' }, 'brussel': { role: 'Actor', password: 'wQnXbF1m)i=b' }, 'cadcock': { role: 'Actor', password: '1*4Y_Z*jzLBR' }, 'cdiaz': { role: 'Actor', password: 'EJqJFWdcHE^0' }, 'csteadham': { role: 'Actor', password: 'GAVX0G3=nvDE' }, 'ckeyes': { role: 'Actor', password: ']wmu?L4!o_D_' }, 'cgaines': { role: 'Actor', password: 'No%vozF1d44@' }, 'dmoore': { role: 'Actor', password: 'dQX!yDw?K3qV' }, 'emorsey': { role: 'Actor', password: 'mDet9LFtP9F:' }, 'edorsey': { role: 'Actor', password: 'M,RA>Yv%61pB' }, 'esharp': { role: 'Actor', password: 'ntggo}k}f0=+' }, 'ebudzilowski': { role: 'Actor', password: 'c)em]MrM~%6r' }, 'hthompson': { role: 'Tech', password: '5LYrGQGk>}}!' }, 'iwilson': { role: 'Tech', password: 'owJ*2#3Fs)-a' }, 'jmoody': { role: 'Actor', password: 'ipvzRL8->tq^' }, 'jteague': { role: 'Actor', password: '}E=UxduA7oh_' }, 'jarcher': { role: 'Actor', password: ',Te:6@8BA_r7' }, 'jsamuelson': { role: 'Actor', password: 'kv344oJxo4?3' }, 'jpoydras': { role: 'Actor', password: 'R9f%T)3b9~19' }, 'jwalker': { role: 'Actor', password: 'fjcxfr~PMFC9' }, 'ksterling': { role: 'Actor', password: 'FLo_b+8TRRW_' }, 'kreading': { role: 'Actor', password: ')rqa8yEDe2PE' }, 'kbates': { role: 'Actor', password: '8BP@Z2rNdP)v' }, 'kringwood': { role: 'Actor', password: '4gTKx.i*_Y:z' }, 'losuna': { role: 'Actor', password: '4gTKx.i*_Y:z' }, 'lponder': { role: 'Actor', password: 'a.F^H2}+Lrtr' }, 'lsinglton': { role: 'Actor', password: 'hZkXikzc0T~)' }, 'lbrown': { role: 'Actor', password: '@g>63W-Y_sM@' }, 'mderrick': { role: 'Actor', password: 'bji656Dj,Fbv' }, 'grandmary': { role: 'Director', password: 'xWpsqQN2k=u1' }, 'msandoval': { role: 'Actor', password: '*22N2p,3Yn+=' }, 'maldridge': { role: 'Actor', password: '5,6sQ@iGt:5?' }, 'noliver': { role: 'Tech', password: 'phrxGHh_3ovX' }, 'phall': { role: 'Actor', password: 'mkw>9D)@m~13' }, 'rhardy': { role: 'Actor', password: '^+bP>j0AW)4i' }, 'btoland': { role: 'Actor', password: '>X-qw0f4zk6W' }, 'rwilson': { role: 'Actor', password: 'j~1QfR0LCY%y' }, 'soneal': { role: 'Actor', password: '1yi~7.nef5CL' }, 'smartin': { role: 'Actor', password: 'Pb}jK35#v]5f' }, 'twashington': { role: 'Actor', password: 'th5b*_Vq^D.+' }, 'tclenny': { role: 'Tech', password: '43-qE-7@BrWt' }, 'vgriffin': { role: 'Actor', password: 'X..b#06ipqAJ' }, 'xmils': { role: 'Tech', password: 'm?98uxvM^18o' }, 'yji': { role: 'Actor', password: 'g5T}QPUMM-e4' }
        };
        const allUsernames = Object.keys(users).sort();
        const groups = {
            "Full Cast": allUsernames,
            "Childrens Ens": ["Anna Claire", "Victoria", "Katherine", "Gianna", "Khloe", "Brooke B", "Landry", "Laylee", "Brooke R", "Mia", "Kaelin", "Jorden", "Madilee", "Emily"],
            "Adult Ens": ["Courtlyn", "Lucy", "Yun (band)", "Annaston", "Addison (band)", "Braden", "Annelise", "Sophee (band)", "Ava", "Julie", "Rodney", "Chrisette", "Jerry (band)", "Carter (band)", "Adam", "Oliver", "Lailia", "Hannah", "Daxton (band)", "Shannon"],
            "Stories": ["Adult Ens. (Not In Band)", "Victoria", "Gianna", "Caurie", "Anna Claire", "Sarah", "Landry", "Mia"],
            "Loud Couples": ["Shannon", "Brooke B", "Carter", "Rylie", "Gianna", "Adam", "Braden", "Courtlyn", "Alexis", "Stella", "Oliver", "Rodney", "Jerry", "Daxton"]
        };

        let currentUser = null;
        let todaysFirstCallTime = null;
        let codeInterval;
        let todaysCalledUsers = new Set();
        let currentAttendanceData = {};

        // --- UTILITY FUNCTIONS ---
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex');}

        // --- UI SETUP ---
        function setupUIForUser() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role;

            const isDirector = currentUser.role === 'Director';
            const isStageManager = currentUser.role === 'Stage Manager';
            
            document.getElementById('add-announcement-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('add-call-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('add-behavior-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('force-show-code-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('export-attendance-button').classList.toggle('hidden', !(isDirector || isStageManager));


            const rehearsalView = document.getElementById('actor-rehearsal-signin-view');
            const smView = document.getElementById('sm-director-attendance-view');
            
            if (isDirector || isStageManager) {
                smView.classList.remove('hidden');
                rehearsalView.classList.remove('hidden'); // Keep this visible for the code display

                // But hide the actor-specific parts inside it
                rehearsalView.querySelector('#signin-code-input').classList.add('hidden');
                rehearsalView.querySelector('#submit-signin-code').classList.add('hidden');
                rehearsalView.querySelector('#signin-status').classList.add('hidden');

                renderFullAttendanceList();
            } else { // Actors, Tech, etc.
                smView.classList.add('hidden');
                rehearsalView.classList.remove('hidden');
                 // For actors, the code display should be hidden by default
                rehearsalView.querySelector('#signin-code-display').classList.add('hidden');
            }
            
            const userSelect = document.getElementById('behavior-user-select');
            userSelect.innerHTML = '<option value="">Select Person...</option>';
            allUsernames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                userSelect.appendChild(option);
            });
            
            populateCallModal();
        }

        function populateCallModal() {
            const groupsContainer = document.getElementById('call-groups-container');
            const individualsContainer = document.getElementById('call-individuals-container');
            groupsContainer.innerHTML = '<h4 class="font-bold text-gray-300 col-span-full">Groups</h4>';
            individualsContainer.innerHTML = '<h4 class="font-bold text-gray-300 col-span-full">Individuals</h4><div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2">';

            Object.keys(groups).forEach(groupName => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="group-${groupName}" name="called-group" type="checkbox" value="${groupName}" class="h-4 w-4 gold-bg border-gray-500 rounded text-[#D4AF37] focus:ring-[#D4AF37]">
                    <label for="group-${groupName}" class="ml-2 block text-sm text-gray-200">${groupName}</label>`;
                groupsContainer.appendChild(div);
            });

            allUsernames.forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="user-${name}" name="called-user" type="checkbox" value="${name}" class="h-4 w-4 gold-bg border-gray-500 rounded text-[#D4AF37] focus:ring-[#D4AF37]">
                    <label for="user-${name}" class="ml-2 block text-sm text-gray-200">${name}</label>`;
                individualsContainer.querySelector('div').appendChild(div);
            });
        }
        
        function renderFullAttendanceList() {
            const list = document.getElementById('attendance-list');
            list.innerHTML = '';
            allUsernames.forEach(name => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-4 items-center gap-2 p-2 rounded-md even:bg-[#2a2a2a]';
                div.innerHTML = `
                    <span class="font-medium col-span-1">${name}</span>
                    <div class="col-span-1 flex items-center space-x-1">
                        <span id="status-${name}" class="text-sm font-semibold text-gray-500"></span>
                        <div id="reason-icon-${name}" class="hidden tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            <span class="tooltiptext"></span>
                        </div>
                    </div>
                    <select data-user="${name}" class="attendance-select col-span-2 bg-[#1E1E1E] border border-gray-600 rounded-md text-white text-sm focus:ring-[#D4AF37] focus:border-[#D4AF37]">
                        <option>Not Marked</option>
                        <option>Not Called</option>
                        <option>Present</option>
                        <option>Tardy</option>
                        <option>Absent</option>
                        <option>Left Early</option>
                    </select>`;
                list.appendChild(div);
            });
        }


        // --- DATA FETCHING & RENDERING ---
        function listenToAnnouncements() {
            const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('announcements-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = `<p class="text-gray-400 text-sm">No announcements yet.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const announcement = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-md bg-[#2a2a2a]';
                    div.innerHTML = `
                        <p class="text-white">${announcement.text}</p>
                        <div class="text-xs text-gray-400 mt-2 flex justify-between items-center">
                            <span>By ${announcement.author} at ${formatTime(announcement.timestamp?.toDate())}</span>
                            ${(currentUser.role === 'Director' || currentUser.role === 'Stage Manager') ? `<button data-id="${doc.id}" class="delete-announcement-btn text-red-500 hover:text-red-400">Delete</button>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
            });
        }

        function listenToCalls() {
            const today = getTodayDateString();
            const q = query(collection(db, 'calls'), where('date', '==', today));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('calls-list');
                list.innerHTML = '';
                 if (snapshot.empty) {
                    list.innerHTML = `<p class="text-gray-400 text-sm">No calls for today.</p>`;
                    todaysFirstCallTime = null;
                    todaysCalledUsers.clear();
                    updateAttendanceUI();
                    return;
                }
                
                todaysCalledUsers.clear();
                let firstCall = null;

                snapshot.docs.forEach(doc => {
                    const call = doc.data();
                    call.called.forEach(name => todaysCalledUsers.add(name));
                    
                    const callTimeDate = new Date(`${call.date}T${call.time}`);
                    if (!firstCall || callTimeDate < firstCall) {
                        firstCall = callTimeDate;
                    }

                    const amICalled = call.called.includes(currentUser.name) || call.called.includes('Full Cast');

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-lg border-l-4 ${amICalled ? 'bg-[#2a2a2a] border-[#D4AF37]' : 'bg-[#1e1e1e] border-gray-600'}`;
                    
                    const calledList = call.called.length > 15 ? `${call.called.slice(0, 15).join(', ')}...` : call.called.join(', ');

                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="text-xl font-bold ${amICalled ? 'gold-text' : 'text-white'}">${formatTime(callTimeDate)} <span class="text-sm font-normal text-gray-300"> (Rehearsal at ${formatTime(new Date(`${call.date}T${call.rehearsalTime}`))})</span></p>
                                <p class="text-gray-200 mt-1">${call.description}</p>
                                <p class="text-xs text-gray-400 mt-2"><b>Called:</b> ${calledList}</p>
                            </div>
                           ${(currentUser.role === 'Director' || currentUser.role === 'Stage Manager') ? `<button data-id="${doc.id}" class="delete-call-btn text-red-500 hover:text-red-400 text-sm">Delete</button>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
                todaysFirstCallTime = firstCall;
                checkTimeToShowCode();
                updateAttendanceUI(); 
            });
        }
        
        function listenToBehaviors() {
            const q = query(collection(db, "behaviors"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('behaviors-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = `<p class="text-gray-400 text-sm">No behavior markers.</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const behavior = doc.data();
                    const isPositive = behavior.type === 'Positive';
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-md border-l-4 ${isPositive ? 'border-green-500 bg-[#2a2a2a]' : 'border-red-500 bg-[#2a2a2a]'}`;
                    div.innerHTML = `
                         <p class="font-semibold text-white">${behavior.userName}</p>
                         <p class="text-sm text-gray-300">${behavior.reason}</p>
                         <div class="text-xs text-gray-400 mt-2 flex justify-between items-center">
                            <span>By ${behavior.author}</span>
                           ${currentUser.role === 'Director' ? `<button data-id="${doc.id}" class="delete-behavior-btn text-red-500 hover:text-red-400">Delete</button>` : ''}
                        </div>`;
                    list.appendChild(div);
                });
            });
        }
        
        function listenToAttendance() {
            const today = getTodayDateString();
            const attendanceCol = collection(db, "attendance", today, "users");
            onSnapshot(attendanceCol, (snapshot) => {
                const attendanceData = {};
                snapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data();
                });
                currentAttendanceData = attendanceData;
                updateAttendanceUI();
            });
        }

        function updateAttendanceUI() {
            if (!currentUser) return;
            
            if (['Director', 'Stage Manager'].includes(currentUser.role)) {
                allUsernames.forEach(name => {
                    const data = currentAttendanceData[name];
                    const isCalled = todaysCalledUsers.has(name);
                    const statusRow = document.getElementById(`status-${name}`);
                    const reasonIcon = document.getElementById(`reason-icon-${name}`);
                    const selectEl = document.querySelector(`.attendance-select[data-user="${name}"]`);
                    
                    if (statusRow && selectEl) {
                        if (data) {
                            statusRow.textContent = data.status;
                            selectEl.value = data.status;

                            if (data.status === 'Present') statusRow.className = 'text-sm font-semibold text-green-400';
                            else if (data.status === 'Tardy') statusRow.className = 'text-sm font-semibold text-yellow-400';
                            else if (data.status === 'Not Called') statusRow.className = 'text-sm font-semibold text-gray-600';
                            else statusRow.className = 'text-sm font-semibold text-red-400';

                            if (data.reason) {
                                reasonIcon.classList.remove('hidden');
                                reasonIcon.querySelector('.tooltiptext').textContent = data.reason;
                            } else {
                                reasonIcon.classList.add('hidden');
                            }
                        } else {
                             if (isCalled) {
                                statusRow.textContent = "Not Marked";
                                statusRow.className = 'text-sm font-semibold text-gray-500';
                                selectEl.value = 'Not Marked';
                            } else {
                                statusRow.textContent = "Not Called";
                                statusRow.className = 'text-sm font-semibold text-gray-600';
                                selectEl.value = 'Not Called';
                            }
                            reasonIcon.classList.add('hidden');
                        }
                    }
                });
            } else { // Actor view
                const myStatus = currentAttendanceData[currentUser.name];
                const statusEl = document.getElementById('signin-status');
                if (myStatus) {
                    statusEl.textContent = `You are marked: ${myStatus.status}`;
                    if (myStatus.status === 'Present') statusEl.className = 'text-center font-semibold text-green-400';
                    else if (myStatus.status === 'Tardy') statusEl.className = 'text-center font-semibold text-yellow-400';
                    else statusEl.className = 'text-center font-semibold text-red-400';
                    document.getElementById('signin-code-input').disabled = true;
                    document.getElementById('submit-signin-code').disabled = true;
                } else {
                     statusEl.textContent = "You have not signed in yet.";
                     statusEl.className = 'text-center font-semibold text-gray-400';
                }
            }
        }
        
        function exportAttendance() {
            let csvContent = "Name,Status,Reason\n";

            allUsernames.forEach(name => {
                const data = currentAttendanceData[name];
                const isCalled = todaysCalledUsers.has(name);
                let status = "";
                let reason = "";

                if (data) {
                    status = data.status;
                    reason = data.reason || "";
                } else {
                    status = isCalled ? "Not Marked" : "Not Called";
                }
                
                const sanitizedReason = `"${reason.replace(/"/g, '""')}"`;
                
                const row = [name, status, sanitizedReason].join(",");
                csvContent += row + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const today = getTodayDateString();
            link.setAttribute("download", `attendance_${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.toLowerCase();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            if (users[name] && users[name].password === password) {
                currentUser = { name: name, role: users[name].role };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                setupUIForUser();
                listenToAnnouncements();
                listenToCalls();
                listenToBehaviors();
                listenToAttendance();
            } else {
                errorEl.textContent = 'Invalid name or password.';
            }
        });
        
        document.getElementById('add-announcement-button').addEventListener('click', () => openModal('announcement-modal'));
        document.getElementById('add-call-button').addEventListener('click', () => openModal('call-modal'));
        document.getElementById('add-behavior-button').addEventListener('click', () => openModal('behavior-modal'));
        
        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('announcement-text').value;
            await addDoc(collection(db, "announcements"), {
                text: text,
                author: currentUser.name,
                timestamp: serverTimestamp()
            });
            e.target.reset();
            closeModal('announcement-modal');
        });

        document.getElementById('call-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const calledSet = new Set();
            document.querySelectorAll('input[name="called-group"]:checked').forEach(input => {
                groups[input.value].forEach(name => calledSet.add(name));
            });
            document.querySelectorAll('input[name="called-user"]:checked').forEach(input => {
                calledSet.add(input.value);
            });

            await addDoc(collection(db, 'calls'), {
                date: document.getElementById('call-date').value,
                time: document.getElementById('call-time').value,
                rehearsalTime: document.getElementById('call-rehearsal-time').value,
                description: document.getElementById('call-description').value,
                called: Array.from(calledSet),
                author: currentUser.name,
            });
            e.target.reset();
            closeModal('call-modal');
        });

        document.getElementById('behavior-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const userName = document.getElementById('behavior-user-select').value;
            await addDoc(collection(db, 'behaviors'), {
                userName: userName,
                type: document.getElementById('behavior-type-select').value,
                reason: document.getElementById('behavior-reason').value,
                author: currentUser.name,
                timestamp: serverTimestamp()
            });
            e.target.reset();
            closeModal('behavior-modal');
        });

        document.getElementById('main-app').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-announcement-btn')) {
                await deleteDoc(doc(db, "announcements", e.target.dataset.id));
            }
            if (e.target.classList.contains('delete-call-btn')) {
                await deleteDoc(doc(db, "calls", e.target.dataset.id));
            }
            if (e.target.classList.contains('delete-behavior-btn')) {
                await deleteDoc(doc(db, "behaviors", e.target.dataset.id));
            }
        });
        
        document.getElementById('submit-signin-code').addEventListener('click', async () => {
             const enteredCode = document.getElementById('signin-code-input').value;
             const today = getTodayDateString();
             const codeDoc = await getDoc(doc(db, "codes", today));
             if(codeDoc.exists() && codeDoc.data().code === enteredCode) {
                await updateAttendance(currentUser.name, 'Present');
             } else {
                const statusEl = document.getElementById('signin-status');
                statusEl.textContent = "Invalid code.";
                statusEl.className = 'text-center font-semibold text-red-400';
             }
        });

        document.getElementById('sm-director-attendance-view').addEventListener('change', (e) => {
            if (e.target.classList.contains('attendance-select')) {
                handleAttendanceChange(e.target);
            }
        });
        
        document.getElementById('export-attendance-button').addEventListener('click', exportAttendance);
        
        document.getElementById('force-show-code-button').addEventListener('click', () => {
             generateAndShowCode(true);
        });

        // --- CORE LOGIC ---
        async function updateAttendance(userName, status, reason = '') {
            const today = getTodayDateString();
            const attendanceRef = doc(db, "attendance", today, "users", userName);
            const attendanceData = {
                status: status,
                timestamp: new Date(),
                markedBy: currentUser.name
            };
            if (reason) {
                attendanceData.reason = reason;
            }
            await setDoc(attendanceRef, attendanceData, { merge: true });

            if (status === 'Tardy' || status === 'Absent') {
                 await addDoc(collection(db, 'behaviors'), {
                    userName: userName,
                    type: 'Negative',
                    reason: `Marked ${status} automatically. ${reason ? 'Reason: ' + reason : 'No reason provided.'}`,
                    author: 'System',
                    timestamp: serverTimestamp()
                });
            }
        }
        
        async function handleAttendanceChange(selectElement) {
            const userName = selectElement.dataset.user;
            const newStatus = selectElement.value;

            if (newStatus === 'Not Called' || newStatus === 'Not Marked') {
                const today = getTodayDateString();
                const attendanceRef = doc(db, "attendance", today, "users", userName);
                const docSnap = await getDoc(attendanceRef);
                if (docSnap.exists()) {
                    await deleteDoc(attendanceRef);
                }
                return;
            }

            if (['Absent', 'Tardy', 'Left Early'].includes(newStatus)) {
                const reasonModal = document.getElementById('reason-modal');
                const reasonForm = document.getElementById('reason-form');
                const reasonTitle = document.getElementById('reason-modal-title');
                
                reasonTitle.textContent = `Reason for ${userName} being ${newStatus}`;
                
                reasonForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const reason = document.getElementById('reason-input').value;
                    await updateAttendance(userName, newStatus, reason);
                    closeModal('reason-modal');
                    reasonForm.reset();
                    reasonForm.onsubmit = null; 
                };
                
                openModal('reason-modal');
            } else {
                await updateAttendance(userName, newStatus);
            }
        }

        async function generateAndShowCode(force = false) {
             const signinCodeDisplay = document.getElementById('signin-code-display');
             const signinCodeTimer = document.getElementById('signin-code-timer');
             const codeEl = document.getElementById('daily-code');

            if (force) {
                signinCodeTimer.classList.add('hidden');
                signinCodeDisplay.classList.remove('hidden');
            }
            
            const today = getTodayDateString();
            const codeRef = doc(db, "codes", today);
            let codeDoc = await getDoc(codeRef);

            let codeToDisplay;
            if (!codeDoc.exists()) {
                const newCode = Math.floor(1000 + Math.random() * 9000).toString();
                await setDoc(codeRef, { code: newCode });
                codeToDisplay = newCode;
            } else {
                codeToDisplay = codeDoc.data().code;
            }
            codeEl.textContent = codeToDisplay;
        }
        
        function checkTimeToShowCode() {
            if (!currentUser) return;

            const actorView = document.getElementById('actor-rehearsal-signin-view');
            const signinCodeDisplay = actorView.querySelector('#signin-code-display');
            const signinCodeTimer = actorView.querySelector('#signin-code-timer');
            
            if (!todaysFirstCallTime) {
                signinCodeDisplay.classList.add('hidden');
                signinCodeTimer.classList.remove('hidden');
                actorView.querySelector('#code-appearance-time').textContent = "No calls today";
                return;
            }
            
            clearInterval(codeInterval);
            codeInterval = setInterval(() => {
                const now = new Date();
                const sixtyMinutesBeforeCall = new Date(todaysFirstCallTime.getTime() - 60 * 60 * 1000);
                
                if (now >= sixtyMinutesBeforeCall) {
                    generateAndShowCode(); // Generate/fetch the code
                    
                    // Only reveal the code display if the user has privileges
                    if (currentUser.role === 'Director' || currentUser.role === 'Stage Manager') {
                        signinCodeDisplay.classList.remove('hidden');
                    }
                    
                    // The timer is no longer needed for anyone
                    signinCodeTimer.classList.add('hidden');
                    clearInterval(codeInterval);
                } else {
                    // Show the countdown timer to everyone
                    signinCodeTimer.classList.remove('hidden');
                    signinCodeDisplay.classList.add('hidden');
                    actorView.querySelector('#code-appearance-time').textContent = formatTime(sixtyMinutesBeforeCall);
                }
            }, 1000);
        }

        window.closeModal = closeModal;

    </script>
</body>
</html>

