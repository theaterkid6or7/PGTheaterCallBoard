<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theater Callboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0C56E; /* Gold text */
        }
        .bg-gold { background-color: #E0C56E; }
        .text-gold { color: #E0C56E; }
        .border-gold { border-color: #E0C56E; }
        .hover-bg-gold-dark:hover { background-color: #c9b062; }
        .bg-dark-gray { background-color: #1E1E1E; }
        .border-dark-gray { border-color: #2d2d2d; }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #1E1E1E;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #E0C56E;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        /* Tooltip for attendance reasons */
        [data-tooltip] {
            position: relative;
            cursor: pointer;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }
        [data-tooltip]:hover::after {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-black">
        <div class="bg-dark-gray p-8 rounded-lg shadow-lg w-full max-w-sm border border-gold">
            <h1 class="text-3xl font-bold text-center text-gold mb-6">Theater Callboard</h1>
            <div id="login-error" class="text-red-500 text-center mb-4 hidden"></div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gold mb-2">Name</label>
                    <input type="text" id="username" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white focus:outline-none focus:ring-2 focus:ring-gold" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gold mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white focus:outline-none focus:ring-2 focus:ring-gold" required>
                </div>
                <button type="submit" class="w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header class="bg-dark-gray p-4 flex justify-between items-center border-b border-gold">
            <div>
                <h1 class="text-2xl font-bold text-gold">Callboard</h1>
                <p class="text-gray-400">Welcome, <span id="user-name" class="font-semibold"></span> (<span id="user-role"></span>)</p>
            </div>
            <button id="logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition duration-300">Logout</button>
        </header>

        <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Announcements -->
                <section id="announcements-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gold">Announcements</h2>
                        <button id="add-announcement-button" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300 hidden">New Announcement</button>
                    </div>
                    <div id="announcements-list" class="bg-dark-gray p-4 rounded-lg border border-dark-gray space-y-4">
                        <!-- Announcements will be injected here -->
                    </div>
                </section>

                <!-- Calls -->
                <section id="calls-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gold">Calls</h2>
                        <button id="add-call-button" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300 hidden">New Call</button>
                    </div>
                    <div id="calls-list" class="bg-dark-gray p-4 rounded-lg border border-dark-gray space-y-4">
                        <!-- Calls will be injected here -->
                    </div>
                </section>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Attendance -->
                <section id="attendance-section">
                    <h2 class="text-2xl font-bold text-gold mb-4">Event Attendance</h2>
                    <div class="bg-dark-gray p-4 rounded-lg border border-dark-gray">
                        <div id="actor-rehearsal-signin-view" class="hidden space-y-4">
                            <h3 class="text-lg font-semibold text-center">Event Sign-In</h3>
                            <div id="signin-code-display" class="text-center p-4 border-2 border-dashed border-gold rounded-md hidden">
                                <p class="text-gray-400">Today's Sign-In Code:</p>
                                <p id="signin-code" class="text-4xl font-bold tracking-widest"></p>
                            </div>
                             <p id="signin-code-timer" class="text-center text-gray-400">The sign-in code will appear 60 minutes before rehearsal.</p>
                            <input type="text" id="signin-code-input" class="w-full text-center px-3 py-2 bg-gray-800 border border-gold rounded-md text-white focus:outline-none focus:ring-2 focus:ring-gold" placeholder="Enter Code to Sign In">
                            <button id="submit-signin-code" class="w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Sign In</button>
                            <p id="signin-status" class="text-center font-semibold"></p>
                            <button id="force-show-code-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 hidden">Force Show Code</button>
                        </div>
                        <div id="sm-director-attendance-view" class="hidden">
                            <h3 class="text-lg font-semibold mb-2">Attendance Roster (<span id="today-date"></span>)</h3>
                             <div id="attendance-list" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Attendance list for SM/Director -->
                            </div>
                        </div>
                    </div>
                </section>
                 <!-- Behavior Markers -->
                <section id="behavior-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gold">Behavior Markers</h2>
                        <button id="add-behavior-button" class="bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300 hidden">New Marker</button>
                    </div>
                    <div id="behavior-list" class="bg-dark-gray p-4 rounded-lg border border-dark-gray space-y-3 max-h-96 overflow-y-auto">
                        <!-- Behavior markers will be injected here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="announcement-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('announcement-modal').style.display='none'">&times;</span>
            <h3 class="text-xl font-bold text-gold mb-4">New Announcement</h3>
            <form id="announcement-form">
                <textarea id="announcement-text" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white focus:outline-none focus:ring-2 focus:ring-gold" required placeholder="Announcement details..."></textarea>
                <button type="submit" class="mt-4 w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Post Announcement</button>
            </form>
        </div>
    </div>
    
    <div id="call-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('call-modal').style.display='none'">&times;</span>
            <h3 class="text-xl font-bold text-gold mb-4">New Call</h3>
            <form id="call-form">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input type="date" id="call-date" class="px-3 py-2 bg-gray-800 border border-gold rounded-md text-white" required>
                    <input type="time" id="call-time" class="px-3 py-2 bg-gray-800 border border-gold rounded-md text-white" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gold mb-2">Who is Called?</label>
                    <div id="call-groups-container" class="space-y-2 max-h-40 overflow-y-auto p-2 border border-gold rounded-md">
                        <!-- Checkboxes for groups and individuals will be inserted here -->
                    </div>
                </div>
                <textarea id="call-notes" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white" placeholder="Additional notes (optional)..."></textarea>
                <button type="submit" class="mt-4 w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Post Call</button>
            </form>
        </div>
    </div>

    <div id="behavior-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('behavior-modal').style.display='none'">&times;</span>
            <h3 class="text-xl font-bold text-gold mb-4">New Behavior Marker</h3>
            <form id="behavior-form">
                <select id="behavior-user-select" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white mb-2" required>
                    <option value="">Select Person...</option>
                </select>
                <select id="behavior-type-select" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white mb-2" required>
                    <option value="Positive">Positive</option>
                    <option value="Negative">Negative</option>
                </select>
                <textarea id="behavior-text" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white" required placeholder="Behavior details..."></textarea>
                <button type="submit" class="mt-4 w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Add Marker</button>
            </form>
        </div>
    </div>

    <div id="attendance-reason-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('attendance-reason-modal').style.display='none'">&times;</span>
            <h3 id="attendance-reason-title" class="text-xl font-bold text-gold mb-4">Add Reason</h3>
            <form id="attendance-reason-form">
                <input type="hidden" id="attendance-reason-user">
                 <input type="hidden" id="attendance-reason-status">
                <textarea id="attendance-reason-text" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gold rounded-md text-white" required placeholder="Reason..."></textarea>
                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="attendance-reason-excused" class="h-4 w-4 rounded border-gray-300 text-gold focus:ring-gold">
                    <label for="attendance-reason-excused" class="ml-2 block text-sm text-gray-300">Excused</label>
                </div>
                <button type="submit" class="mt-4 w-full bg-gold text-black font-bold py-2 px-4 rounded-md hover-bg-gold-dark transition duration-300">Submit Reason</button>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, deleteDoc, setDoc, query, where, serverTimestamp, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- USER DATA ---
        const users = {
            'lnewton': { pass: '?2@2yzz~PVJf', role: 'Director' }, 'tbeck': { pass: 'pHR68Db.Pw.#', role: 'AD/Coreography' }, 'gloshe': { pass: 'iT=hy!7G9NTf', role: 'Director' }, 
            'bflieder': { pass: '-W9m=>D_AUzF', role: 'Tech Director' }, 'cclark': { pass: 'iJ+va7>Df}#@', role: 'ATD' }, 'ljulien': { pass: ';3y2Paz9£9?m', role: 'Stage Manager' }, 
            'hflowers': { pass: 'i£08um?B51.x', role: 'Stage Manager' }, 'nwalker': { pass: '9^1~R7C*QVdV', role: 'Stage Manager' }, 'apate': { pass: 'y~D+V3R-37Wt', role: 'Actor' }, 
            'cbeck': { pass: 'G?5sLRCkZYCg', role: 'Actor' }, 'sjulien': { pass: '#0Y57gk*b?Jq', role: 'Actor' }, 'agipson': { pass: 'c!?xGW2JvB:2', role: 'Actor' }, 
            'owyatt': { pass: '9vq-B#4q]}>.', role: 'Actor' }, 'swyatt': { pass: 'B?2jjtvNqtq_', role: 'Actor' }, 'afry': { pass: '5Mxc,kQpd,!T', role: 'Actor' }, 
            'rromero': { pass: '=4A*pq+xQq:!', role: 'Actor' }, 'gromero': { pass: 'j.dab8,6X_m2', role: 'Actor' }, 'adalton': { pass: 'N.K#K9K.F60W', role: 'Actor' }, 
            'afooter': { pass: '3g0w]*Lt>~]D', role: 'Tech' }, 'acollins': { pass: 'MU?#03xg.GQw', role: 'Actor' }, 
            'achasteen': { pass: '1k#VK*b~!yWA', role: 'Actor' }, 'agibson': { pass: '64KmMFCb>C.y', role: 'Actor' }, 'aaslin': { pass: 'YMDke#Pj23sV', role: 'Tech' }, 
            'abobo': { pass: '=#.C_R.CLu1C', role: 'Actor' }, 'bfrazier': { pass: ']r)i]-]%6*1v', role: 'Actor' }, 
            'bdavis': { pass: 'h)~3c4^@9oow', role: 'Tech' }, 'bbenich': { pass: 'q!o)%+h@Fz7-', role: 'Actor' }, 'brussel': { pass: 'wQnXbF1m)i=b', role: 'Actor' }, 
            'cadcock': { pass: '1*4Y_Z*jzLBR', role: 'Actor' }, 'cdiaz': { pass: 'EJqJFWdcHE^0', role: 'Actor' }, 'csteadham': { pass: 'GAVX0G3=nvDE', role: 'Actor' }, 
            'ckeyes': { pass: ']wmu?L4!o_D_', role: 'Actor' }, 'cgaines': { pass: 'No%vozF1d44@', role: 'Actor' }, 'dmoore': { pass: 'dQX!yDw?K3qV', role: 'Actor' }, 
            'emorsey': { pass: 'mDet9LFtP9F:', role: 'Actor' }, 'edorsey': { pass: 'M,RA>Yv%61pB', role: 'Actor' }, 'esharp': { pass: 'ntggo}k}f0=+', role: 'Actor' }, 
            'ebudzilowski': { pass: 'c)em]MrM~%6r', role: 'Actor' }, 'hthompson': { pass: '5LYrGQGk>}}!', role: 'Tech' }, 'iwilson': { pass: 'owJ*2#3Fs)-a', role: 'Tech' }, 
            'jmoody': { pass: 'ipvzRL8->tq^', role: 'Actor' }, 'jteague': { pass: '}E=UxduA7oh_', role: 'Actor' }, 'jarcher': { pass: ',Te:6@8BA_r7', role: 'Actor' }, 
            'jsamuelson': { pass: 'kv344oJxo4?3', role: 'Actor' }, 'jpoydras': { pass: 'R9f%T)3b9~19', role: 'Actor' }, 'jwalker': { pass: 'fjcxfr~PMFC9', role: 'Actor' }, 
            'ksterling': { pass: 'FLo_b+8TRRW_', role: 'Actor' }, 'kreading': { pass: ')rqa8yEDe2PE', role: 'Actor' }, 'kbates': { pass: '8BP@Z2rNdP)v', role: 'Actor' }, 
            'kringwood': { pass: '4gTKx.i*_Y:z', role: 'Actor' }, 'losuna': { pass: '4gTKx.i*_Y:z', role: 'Actor' }, 'lponder': { pass: 'a.F^H2}+Lrtr', role: 'Actor' }, 
            'lsinglton': { pass: 'hZkXikzc0T~)', role: 'Actor' }, 'lbrown': { pass: '@g>63W-Y_sM@', role: 'Actor' }, 'mderrick': { pass: 'bji656Dj,Fbv', role: 'Actor' }, 
            'grandmary': { pass: 'xWpsqQN2k=u1', role: 'Director' }, 'msandoval': { pass: '*22N2p,3Yn+=', role: 'Actor' }, 'maldridge': { pass: '5,6sQ@iGt:5?', role: 'Actor' }, 
            'noliver': { pass: 'phrxGHh_3ovX', role: 'Tech' }, 'phall': { pass: 'mkw>9D)@m~13', role: 'Actor' }, 'rhardy': { pass: '^+bP>j0AW)4i', role: 'Actor' }, 
            'btoland': { pass: '>X-qw0f4zk6W', role: 'Actor' }, 'rwilson': { pass: 'j~1QfR0LCY%y', role: 'Actor' }, 'soneal': { pass: '1yi~7.nef5CL', role: 'Actor' }, 
            'smartin': { pass: 'Pb}jK35#v]5f', role: 'Actor' }, 'twashington': { pass: 'th5b*_Vq^D.+', role: 'Actor' }, 'tclenny': { pass: '43-qE-7@BrWt', role: 'Tech' }, 
            'vgriffin': { pass: 'X..b#06ipqAJ', role: 'Actor' }, 'xmils': { pass: 'm?98uxvM^18o', role: 'Tech' }, 'yji': { pass: 'g5T}QPUMM-e4', role: 'Actor' }
        };
        const allUsernames = Object.keys(users).sort();
        const groups = {
            "Childrens Ens": ["acollins", "vgriffin", "ksterling", "gromero", "kringwood", "brussel", "lponder", "lsinglton", "brussel", "msandoval", "kreading", "jpoydras", "emorsey"],
            "Adult Ens": ["cbeck", "lsinglton", "yji", "apate", "bbenich", "sjulien", "soneal", "rhardy", "csteadham", "jarcher", "rwilson", "jwalker", "cdiaz", "achasteen", "adam", "noliver", "lbrown", "hthompson", "dmoore", "smartin", "bfrazier"],
            "Stories": ["cbeck", "lsinglton", "yji", "apate", "bbenich", "vgriffin", "gromero", "cadcock", "acollins", "sjulien", "lponder", "msandoval", "rhardy"],
            "Loud Couples": ["soneal", "brussel", "cdiaz", "rwilson", "gromero", "bbenich", "sjulien", "cbeck", "abobo", "noliver", "rhardy", "jwalker", "dmoore"],
        };

        // --- FIREBASE CONFIG ---
        // This configuration uses the latest details you provided.
        const firebaseConfig = {
          apiKey: "AIzaSyAACv92bzY5cECbECBtsw6oyxrUnEBaJMY",
          authDomain: "pg-theater-call-board.firebaseapp.com",
          projectId: "pg-theater-call-board",
          storageBucket: "pg-theater-call-board.firebasestorage.app",
          messagingSenderId: "850857757575",
          appId: "1:850857757575:web:8ef2834994186fabaea122",
          measurementId: "G-1DNV9KENSJ"
        };
        const appId = 'pg-theater-callboard-app'; // A unique ID for your app's data collections

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- APP STATE ---
        let currentUser = null;
        let unsubscribeAnnouncements = null;
        let unsubscribeCalls = null;
        let unsubscribeAttendance = null;
        let unsubscribeBehavior = null;
        let rehearsalStartTime = new Date();
        rehearsalStartTime.setHours(19, 0, 0, 0); // 7:00 PM
        let signinCode = '';

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (users[username] && users[username].pass === password) {
                currentUser = {
                    name: username,
                    role: users[username].role,
                };
                sessionStorage.setItem('theaterUser', JSON.stringify(currentUser));
                initializeAppState();
            } else {
                loginError.textContent = 'Invalid username or password.';
                loginError.classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('theaterUser');
            // Detach listeners
            if (unsubscribeAnnouncements) unsubscribeAnnouncements();
            if (unsubscribeCalls) unsubscribeCalls();
            if (unsubscribeAttendance) unsubscribeAttendance();
            if (unsubscribeBehavior) unsubscribeBehavior();

            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        });

        // --- APP INITIALIZATION ---
        async function initializeAppState() {
            if (!currentUser) return;
            try {
                await signInAnonymously(auth);
            } catch(e) {
                console.error("Firebase sign-in failed: ", e);
                // Display a user-friendly error on the login screen
                loginError.textContent = 'Connection failed. Please refresh.';
                loginError.classList.remove('hidden');
                // Log the user out of the broken state
                document.getElementById('logout-button').click();
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user && currentUser) {
                console.log("Firebase user signed in:", user.uid);
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                setupUIForUser();
                attachFirestoreListeners();
            } else {
                console.log("No Firebase user.");
            }
        });

        // --- UI SETUP ---
        function setupUIForUser() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role;

            const isDirector = currentUser.role === 'Director';
            const isStageManager = currentUser.role === 'Stage Manager';
            
            // Show/hide buttons based on role
            document.getElementById('add-announcement-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('add-call-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('add-behavior-button').classList.toggle('hidden', !(isDirector || isStageManager));
            document.getElementById('force-show-code-button').classList.toggle('hidden', !isDirector);

            // Setup attendance view
            const rehearsalView = document.getElementById('actor-rehearsal-signin-view');
            const smView = document.getElementById('sm-director-attendance-view');
            if (isDirector || isStageManager) {
                rehearsalView.classList.add('hidden');
                smView.classList.remove('hidden');
                renderFullAttendanceList();
            } else {
                smView.classList.add('hidden');
                rehearsalView.classList.remove('hidden');
            }
            
            // Populate behavior user select
            const userSelect = document.getElementById('behavior-user-select');
            userSelect.innerHTML = '<option value="">Select Person...</option>';
            allUsernames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                userSelect.appendChild(option);
            });

            // Populate call groups select
            populateCallGroups();
        }
        
        function populateCallGroups() {
            const container = document.getElementById('call-groups-container');
            container.innerHTML = '';
            
            const createCheckbox = (id, value, label, isGroup = false) => `
                <div class="flex items-center">
                    <input type="checkbox" id="${id}" value="${value}" name="${isGroup ? 'group' : 'individual'}" class="h-4 w-4 rounded border-gray-300 text-gold focus:ring-gold">
                    <label for="${id}" class="ml-2 block text-sm ${isGroup ? 'font-bold' : 'text-gray-300'}">${label}</label>
                </div>`;
            
            container.innerHTML += createCheckbox('group-fullcast', 'Full Cast', 'Full Cast', true);
            
            Object.keys(groups).sort().forEach(groupName => {
                container.innerHTML += createCheckbox(`group-${groupName.replace(/\s+/g, '')}`, groupName, groupName, true);
            });

            container.innerHTML += `<hr class="border-gray-600 my-2">`; // Separator
            
            allUsernames.forEach(name => {
                container.innerHTML += createCheckbox(`individual-${name}`, name, name, false);
            });
        }
        
        // --- FIRESTORE LISTENERS ---
        function attachFirestoreListeners() {
            const todayStr = getTodayString();
            
            // Announcements
            const announcementsRef = collection(db, 'artifacts', appId, 'public', 'data', 'announcements');
            unsubscribeAnnouncements = onSnapshot(query(announcementsRef), (snapshot) => {
                const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                renderAnnouncements(announcements);
            });

            // Calls
            const callsRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls');
            unsubscribeCalls = onSnapshot(query(callsRef), (snapshot) => {
                const calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.callDateTime - a.callDateTime);
                renderCalls(calls);
            });
            
            // Attendance
            const attendanceRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendance', todayStr, 'users');
            unsubscribeAttendance = onSnapshot(attendanceRef, (snapshot) => {
                const attendanceData = {};
                snapshot.docs.forEach(doc => {
                    attendanceData[doc.id] = doc.data();
                });
                updateAttendanceUI(attendanceData);
            });

            // Behavior
            const behaviorRef = collection(db, 'artifacts', appId, 'public', 'data', 'behavior');
            unsubscribeBehavior = onSnapshot(query(behaviorRef), (snapshot) => {
                 const markers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                 renderBehaviorMarkers(markers);
            });
        }

        // --- RENDERING FUNCTIONS ---
        function renderAnnouncements(announcements) {
            const list = document.getElementById('announcements-list');
            list.innerHTML = '';
            if (announcements.length === 0) {
                list.innerHTML = `<p class="text-gray-400">No announcements yet.</p>`;
                return;
            }
            announcements.forEach(item => {
                const canDelete = currentUser.role === 'Director' || currentUser.role === 'Stage Manager';
                const date = item.timestamp?.toDate().toLocaleString() || 'just now';
                list.innerHTML += `
                    <div class="p-3 bg-gray-800 rounded-md">
                        <p class="text-white whitespace-pre-wrap">${item.text}</p>
                        <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                            <span>By ${item.author} on ${date}</span>
                            ${canDelete ? `<button class="delete-announcement-btn text-red-500 hover:text-red-400" data-id="${item.id}">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function renderCalls(calls) {
            const list = document.getElementById('calls-list');
            list.innerHTML = '';
             if (calls.length === 0) {
                list.innerHTML = `<p class="text-gray-400">No calls have been posted.</p>`;
                return;
            }
            calls.forEach(item => {
                const canDelete = currentUser.role === 'Director' || currentUser.role === 'Stage Manager';
                const callDate = item.callDateTime?.toDate();
                if (!callDate) return;

                const formattedDate = callDate.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                const formattedTime = callDate.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });

                let calledText = '';
                if(item.called.groups?.includes("Full Cast")) {
                    calledText = '<strong>Full Cast</strong>';
                } else {
                    const allCalled = [...(item.called.groups || []), ...(item.called.individuals || [])];
                    calledText = allCalled.join(', ');
                }

                 list.innerHTML += `
                    <div class="p-3 bg-gray-800 rounded-md">
                        <p class="text-white">
                            <strong class="text-gold">${formattedDate} at ${formattedTime}:</strong> 
                            <span>${calledText}</span>
                        </p>
                        ${item.notes ? `<p class="text-gray-300 mt-1 text-sm italic">Note: ${item.notes}</p>`: ''}
                        <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                             <span>Posted by ${item.author}</span>
                            ${canDelete ? `<button class="delete-call-btn text-red-500 hover:text-red-400" data-id="${item.id}">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        function renderBehaviorMarkers(markers) {
            const list = document.getElementById('behavior-list');
            list.innerHTML = '';
            const canSeeAll = currentUser.role === 'Director' || currentUser.role === 'Stage Manager';
            const canDelete = currentUser.role === 'Director';

            const userMarkers = markers.filter(m => canSeeAll || m.user === currentUser.name);

            if (userMarkers.length === 0) {
                list.innerHTML = `<p class="text-gray-400">No behavior markers to show.</p>`;
                return;
            }
            
            userMarkers.forEach(marker => {
                 const date = marker.timestamp?.toDate().toLocaleString() || 'just now';
                 const colorClass = marker.type === 'Positive' ? 'text-green-400' : 'text-red-400';
                 list.innerHTML += `
                    <div class="p-3 bg-gray-800 rounded-md text-sm">
                        <p class="font-bold ${colorClass}">${marker.type} marker for ${marker.user}</p>
                        <p class="text-white mt-1">${marker.text}</p>
                        <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                            <span>By ${marker.author} on ${date}</span>
                            ${canDelete ? `<button class="delete-behavior-btn text-red-500 hover:text-red-400" data-id="${marker.id}">Delete</button>` : ''}
                        </div>
                    </div>
                 `;
            });
        }

        
        function renderFullAttendanceList() {
            const list = document.getElementById('attendance-list');
            list.innerHTML = '';
            allUsernames.forEach(name => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-800 rounded" id="attendance-row-${name}">
                        <span class="text-white">${name}</span>
                        <div class="flex items-center gap-2">
                             <span id="reason-icon-${name}" class="hidden" data-tooltip="">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill text-blue-400" viewBox="0 0 16 16">
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                                </svg>
                            </span>
                            <span class="text-sm font-semibold text-gray-500" id="status-${name}">Not Marked</span>
                            <select class="attendance-select bg-gray-700 text-white rounded p-1 text-xs" data-user="${name}">
                                <option value="Present">Present</option>
                                <option value="Tardy">Tardy</option>
                                <option value="Absent">Absent</option>
                                <option value="Left Early">Left Early</option>
                            </select>
                        </div>
                    </div>
                `;
            });
        }
        
        function updateAttendanceUI(attendanceData) {
            // Actor view
            const myStatus = attendanceData[currentUser.name];
            const statusEl = document.getElementById('signin-status');
            if (myStatus) {
                statusEl.textContent = `You are marked: ${myStatus.status}`;
                if (myStatus.status === 'Present') statusEl.className = 'text-center font-semibold text-green-400';
                else if (myStatus.status === 'Tardy') statusEl.className = 'text-center font-semibold text-yellow-400';
                else statusEl.className = 'text-center font-semibold text-red-400';
                document.getElementById('signin-code-input').disabled = true;
                document.getElementById('submit-signin-code').disabled = true;
            } else {
                 statusEl.textContent = "You have not signed in yet.";
                 statusEl.className = 'text-center font-semibold text-gray-400';
            }

            // SM/Director View
            allUsernames.forEach(name => {
                const data = attendanceData[name];
                const statusRow = document.getElementById(`status-${name}`);
                const reasonIcon = document.getElementById(`reason-icon-${name}`);
                
                if (statusRow) {
                    if (data) {
                        statusRow.textContent = data.status;
                        if (data.status === 'Present') statusRow.className = 'text-sm font-semibold text-green-400';
                        else if (data.status === 'Tardy') statusRow.className = 'text-sm font-semibold text-yellow-400';
                        else statusRow.className = 'text-sm font-semibold text-red-400';

                        if (data.reason) {
                            reasonIcon.classList.remove('hidden');
                            reasonIcon.dataset.tooltip = data.reason;
                        } else {
                            reasonIcon.classList.add('hidden');
                        }

                    } else {
                        statusRow.textContent = "Not Marked";
                        statusRow.className = 'text-sm font-semibold text-gray-500';
                        reasonIcon.classList.add('hidden');
                    }
                }
            });
        }


        // --- EVENT HANDLERS ---
        // Modals
        document.getElementById('add-announcement-button').addEventListener('click', () => document.getElementById('announcement-modal').style.display = 'block');
        document.getElementById('add-call-button').addEventListener('click', () => document.getElementById('call-modal').style.display = 'block');
        document.getElementById('add-behavior-button').addEventListener('click', () => document.getElementById('behavior-modal').style.display = 'block');
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
        
        // Forms
        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('announcement-text').value;
            const announcementsRef = collection(db, 'artifacts', appId, 'public', 'data', 'announcements');
            await addDoc(announcementsRef, {
                text: text,
                author: currentUser.name,
                timestamp: serverTimestamp()
            });
            e.target.reset();
            document.getElementById('announcement-modal').style.display = 'none';
        });

        document.getElementById('call-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('call-date').value;
            const time = document.getElementById('call-time').value;
            const notes = document.getElementById('call-notes').value;

            if (!date || !time) {
                alert("Please select a date and time for the call.");
                return;
            }
            const callDateTime = new Date(`${date}T${time}`);

            const selectedGroups = Array.from(document.querySelectorAll('#call-groups-container input[name="group"]:checked')).map(el => el.value);
            const selectedIndividuals = Array.from(document.querySelectorAll('#call-groups-container input[name="individual"]:checked')).map(el => el.value);

            if(selectedGroups.length === 0 && selectedIndividuals.length === 0) {
                alert("Please select who is called.");
                return;
            }

            const callsRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls');
            await addDoc(callsRef, {
                callDateTime: Timestamp.fromDate(callDateTime),
                called: {
                    groups: selectedGroups,
                    individuals: selectedIndividuals,
                },
                notes: notes,
                author: currentUser.name,
                timestamp: serverTimestamp()
            });
            e.target.reset();
            document.getElementById('call-modal').style.display = 'none';
        });

        document.getElementById('behavior-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('behavior-user-select').value;
            const type = document.getElementById('behavior-type-select').value;
            const text = document.getElementById('behavior-text').value;
            if(!user) { alert("Please select a person."); return; }
            const behaviorRef = collection(db, 'artifacts', appId, 'public', 'data', 'behavior');
            await addDoc(behaviorRef, {
                user, type, text,
                author: currentUser.name,
                timestamp: serverTimestamp()
            });
            e.target.reset();
            document.getElementById('behavior-modal').style.display = 'none';
        });
        
        document.getElementById('attendance-reason-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName = document.getElementById('attendance-reason-user').value;
            const status = document.getElementById('attendance-reason-status').value;
            const reason = document.getElementById('attendance-reason-text').value;
            const excused = document.getElementById('attendance-reason-excused').checked;
            
            const todayStr = getTodayString();
            const userAttendanceRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', todayStr, 'users', userName);
            await setDoc(userAttendanceRef, { 
                status: status, 
                reason: reason,
                excused: excused,
                markedBy: currentUser.name, 
                timestamp: serverTimestamp() 
            });

            // Auto-generate behavior marker for unexcused issues
            if (!excused && (status === 'Absent' || status === 'Tardy')) {
                const behaviorRef = collection(db, 'artifacts', appId, 'public', 'data', 'behavior');
                await addDoc(behaviorRef, {
                    user: userName,
                    type: 'Negative',
                    text: `Unexcused ${status} on ${new Date().toLocaleDateString()}. Reason: ${reason}`,
                    author: 'System',
                    timestamp: serverTimestamp()
                });
            }

            e.target.reset();
            document.getElementById('attendance-reason-modal').style.display = 'none';
        });


        // Deletes
        document.addEventListener('click', async (e) => {
            if(e.target.classList.contains('delete-announcement-btn')) {
                const id = e.target.dataset.id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'announcements', id));
            }
            if(e.target.classList.contains('delete-call-btn')) {
                const id = e.target.dataset.id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', id));
            }
            if(e.target.classList.contains('delete-behavior-btn')) {
                const id = e.target.dataset.id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'behavior', id));
            }
        });

        // Attendance marking (for SM/Director)
        document.getElementById('attendance-list').addEventListener('change', async (e) => {
            if (e.target.classList.contains('attendance-select')) {
                const userName = e.target.dataset.user;
                const status = e.target.value;
                const todayStr = getTodayString();
                const userAttendanceRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', todayStr, 'users', userName);

                if (status === 'Present') {
                    await setDoc(userAttendanceRef, { status: status, markedBy: currentUser.name, timestamp: serverTimestamp() });
                } else {
                    // Open modal for reason
                    document.getElementById('attendance-reason-user').value = userName;
                    document.getElementById('attendance-reason-status').value = status;
                    document.getElementById('attendance-reason-title').textContent = `Reason for ${userName} being ${status}`;
                    document.getElementById('attendance-reason-modal').style.display = 'block';
                    // Reset the dropdown in case they cancel
                    e.target.value = 'Present'; 
                }
            }
        });
        
        // Rehearsal sign-in (for Actors/Tech)
        document.getElementById('submit-signin-code').addEventListener('click', async () => {
             const enteredCode = document.getElementById('signin-code-input').value;
             if (enteredCode === signinCode && signinCode !== '') {
                const todayStr = getTodayString();
                const userAttendanceRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', todayStr, 'users', currentUser.name);
                await setDoc(userAttendanceRef, { status: 'Present', markedBy: 'Self', timestamp: serverTimestamp() });
             } else {
                alert('Invalid sign-in code.');
             }
        });

        
        document.getElementById('force-show-code-button').addEventListener('click', () => {
             document.getElementById('signin-code-display').classList.remove('hidden');
             document.getElementById('signin-code-timer').classList.add('hidden');
        });


        // --- HELPERS & TIMERS ---
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function generateSigninCode() {
            const date = new Date();
            const day = date.getDate();
            const month = date.getMonth() + 1;
            // Simple but non-obvious code
            const code = (day * 17 + month * 31) % 10000;
            return code.toString().padStart(4, '0');
        }

        function checkTimeToShowCode() {
            const now = new Date();
            const timeUntilRehearsal = rehearsalStartTime.getTime() - now.getTime();
            const minutesUntil = timeUntilRehearsal / (1000 * 60);

            if (minutesUntil <= 60 && now < rehearsalStartTime) {
                document.getElementById('signin-code-display').classList.remove('hidden');
                document.getElementById('signin-code-timer').classList.add('hidden');
            } else {
                 document.getElementById('signin-code-display').classList.add('hidden');
                 document.getElementById('signin-code-timer').classList.remove('hidden');
                 document.getElementById('signin-code-timer').textContent = `Sign-in code will appear at ${new Date(rehearsalStartTime.getTime() - 60*60*1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}.`;
            }
        }

        // --- ON LOAD ---
        window.addEventListener('load', () => {
            const savedUser = sessionStorage.getItem('theaterUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initializeAppState();
            }
            
            document.getElementById('today-date').textContent = new Date().toLocaleDateString();
            signinCode = generateSigninCode();
            document.getElementById('signin-code').textContent = signinCode;

            checkTimeToShowCode();
            setInterval(checkTimeToShowCode, 30000); // Check every 30 seconds
        });

    </script>
</body>
</html>


