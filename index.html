<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PG Theater Call Board — Live</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070607; --card:#0f0f10; --gold:#FFD166; --gold-2:#e0b64f; --muted:#9b9b9b; --danger:#e74c3c; --success:#2ecc71;
  --radius:12px; --shadow:0 10px 30px rgba(0,0,0,0.6); --maxw:1280px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000);color:var(--gold);font-family:Inter,system-ui,Roboto,Arial;-webkit-font-smoothing:antialiased}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.75));border-bottom:1px solid rgba(255,215,102,0.04);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-2));display:flex;align-items:center;justify-content:center;color:#000;font-weight:800}
.header-right{display:flex;align-items:center;gap:10px}
.container{max-width:var(--maxw);margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr 420px;gap:18px}
@media(max-width:980px){.container{grid-template-columns:1fr;padding:0 12px}}
.card{background:linear-gradient(180deg,var(--card),#0c0c0c);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(255,215,102,0.04)}
h1,h2{margin:0}
h2{font-size:1rem;color:var(--gold);margin-bottom:8px}
.input, select, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--gold); margin-top:6px; font-size:0.95rem;}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn-primary{background:var(--gold);color:#000}
.btn-ghost{background:transparent;color:var(--gold);border:1px solid rgba(255,255,255,0.04)}
.btn-danger{background:var(--danger);color:#fff}
.btn-sm{padding:6px 8px;font-size:0.9rem;border-radius:6px}
.hidden{display:none!important}
.small{font-size:0.9rem;color:var(--muted)}
.entry-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.table th{font-weight:700;color:var(--gold);text-align:left}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:200}
.modal-card{width:560px;max-width:94%;background:linear-gradient(180deg,var(--card),#0f0f0f);padding:18px;border-radius:12px;border:1px solid rgba(255,215,102,0.06);box-shadow:0 12px 40px rgba(0,0,0,0.7)}
.fade-in{animation:fadeIn .22s ease-in}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Attendance table wrapper for preventing overflow (right column) */
#attendanceWrapper{max-height:420px;overflow:auto;border-radius:8px;padding-right:6px}
#attendanceTable{width:100%;min-width:760px;border-collapse:collapse}
#attendanceTable th,#attendanceTable td{border:1px solid rgba(255,215,102,0.06);padding:8px;vertical-align:middle;white-space:nowrap}
.col-wrap{max-width:160px;white-space:normal;word-break:break-word}

/* Big attendance REPORT on LEFT — wider and left-shifted */
#attendanceReportLargeCard {
  grid-column: 1 / 2; /* make sure it sits in left column */
  margin-bottom: 12px;
}
#attendanceReportLarge {
  max-height:520px;
  overflow:auto;
  border-radius:10px;
  padding-right:8px;
}
#attendanceReportLarge table{min-width:900px}

/* responsive adjustments */
@media(max-width:980px){
  #attendanceReportLarge table{min-width:700px}
  #attendanceTable{min-width:700px}
}

/* small styles */
.badge{padding:6px 8px;border-radius:8px;font-weight:700}
.present{background:rgba(46,204,113,0.12);color:var(--success)}
.absent{background:rgba(231,76,60,0.08);color:var(--danger)}
.tardy{background:rgba(255,215,102,0.08);color:var(--gold)}
.left{background:rgba(200,200,200,0.06);color:#ccc}
.small-muted{font-size:0.85rem;color:var(--muted)}
/* center login */
#signinFullScreen {
  position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
  z-index:400;
}
#signinBox { width:420px; max-width:94%; background: linear-gradient(180deg,var(--card),#0f0f0f); border-radius:12px; padding:20px; border:1px solid rgba(255,215,102,0.06); box-shadow: 0 18px 60px rgba(0,0,0,0.7); text-align:left; }
#signinBox h2{color:var(--gold); margin:0 0 10px 0}
#signinBox .input{margin:8px 0}
.small-note{font-size:0.85rem;color:var(--muted); margin-top:8px}
</style>
</head>
<body>

<!-- header -->
<div class="header">
  <div class="brand">
    <div class="logo">PG</div>
    <div>
      <div style="font-weight:800">PG Theater</div>
      <div style="font-size:0.78rem;color:rgba(255,215,102,0.85)">Call Board — Live</div>
    </div>
  </div>

  <div class="header-right">
    <!-- keep small creds in header but the main entry is full-screen modal -->
    <div id="signed-in-controls" class="hidden" style="align-items:center;gap:12px">
      <div id="signedInAs" class="small"></div>
      <button id="signoutBtn" class="btn btn-ghost">Sign Out</button>
    </div>
  </div>
</div>

<!-- Sign-in full-screen modal (rest of app hidden behind until login) -->
<div id="signinFullScreen">
  <div id="signinBox">
    <h2>Sign In — PG Theater Call Board</h2>
    <div class="small-muted">Use your username and password. Everything is private until you sign in.</div>
    <input id="usernameInput" class="input" placeholder="username">
    <input id="passwordInput" class="input" placeholder="password" type="password">
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <button id="signinBtn" class="btn btn-primary">Sign In</button>
      <button id="signinCancelBtn" class="btn btn-ghost" title="Hide sign-in? (not recommended)">Cancel</button>
    </div>
    <div class="small-note">Directors: lnewton -> cclark. Stage Managers: nwalker -> ljulien. Actors will see only their calls and attendance.</div>
  </div>
</div>

<!-- main container (hidden behind sign-in modal until login) -->
<div class="container" id="mainApp" style="visibility:hidden;">

  <!-- Attendance Report Large Card (left column, prominent) -->
  <div id="attendanceReportLargeCard" class="card fade-in">
    <h2>Attendance Report (Large)</h2>
    <div id="attendanceReportLarge" class="small-muted">
      <!-- big table rendered here for SMs/Directors -->
      <div id="attendanceReportLargeInner">Sign in to view report.</div>
    </div>
    <div style="margin-top:8px" class="small-muted">This report shows all actors, their latest status, reason, time, and who marked them.</div>
  </div>

  <!-- LEFT column: Schedule + Announcements -->
  <div>
    <div id="directorSummaryCard" class="card hidden fade-in">
      <h2>Next Calls (Directors)</h2>
      <div id="nextCallsList" class="small"></div>
    </div>

    <div class="card fade-in">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Schedule</h2>
        <div><button id="toggleScheduleForm" class="btn btn-primary hidden">+ New Call</button></div>
      </div>

      <div id="scheduleForm" class="hidden" style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <input id="callDate" type="date" class="input">
          <input id="callTime" type="time" class="input">
        </div>
        <label class="small">Select actors (ctrl/shift to multi-select)</label>
        <select id="callWho" multiple size="6" style="height:130px;margin-top:6px" class="input"></select>
        <input id="callDetails" class="input" placeholder="Details (location, notes)">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addCallBtn" class="btn btn-primary">Add Call</button>
          <button id="cancelCallBtn" class="btn btn-ghost">Cancel</button>
        </div>
      </div>

      <div id="scheduleList" style="margin-top:12px"></div>
    </div>

    <div class="card fade-in">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Announcements</h2>
        <div><button id="toggleAnnForm" class="btn btn-primary hidden">+ New</button></div>
      </div>

      <div id="annForm" class="hidden" style="margin-top:10px">
        <textarea id="announcementText" rows="3" placeholder="Write announcement..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addAnnouncementBtn" class="btn btn-primary">Post</button>
          <button id="cancelAnnBtn" class="btn btn-ghost">Cancel</button>
        </div>
      </div>

      <div id="announcementsList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- RIGHT column: Attendance live + Director tools -->
  <div>
    <div class="card fade-in">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Attendance (Quick)</h2>
        <div><button id="exportCsvBtn" class="btn btn-primary hidden">Export CSV</button></div>
      </div>

      <div id="attendanceWrapper">
        <table id="attendanceTable" class="table" aria-live="polite">
          <thead>
            <tr>
              <th>Actor</th>
              <th>Status</th>
              <th class="col-wrap">Reason</th>
              <th>Time</th>
              <th>Marked By</th>
              <th class="manageCol hidden">Actions</th>
            </tr>
          </thead>
          <tbody id="attendanceList"></tbody>
        </table>
      </div>
    </div>

    <div id="directorControls" class="card hidden fade-in">
      <h2>Director Tools</h2>
      <div style="display:flex;gap:8px;flex-direction:column">
        <button id="forceMarkBtn" class="btn btn-primary">Force Mark All Present</button>
        <div class="small" style="margin-top:8px">Force-mark sets unmarked actors Present and records you as the marker.</div>
      </div>
    </div>
  </div>
</div>

<!-- Attendance modal -->
<div id="attendanceModal" class="modal">
  <div class="modal-card">
    <h3>Mark Attendance</h3>
    <div style="margin-top:8px">
      <label class="small">Status</label>
      <select id="attendanceSelect" class="input">
        <option>Present</option>
        <option>Absent</option>
        <option>Tardy</option>
        <option>Left Early</option>
      </select>
    </div>
    <div id="absenceLauncher" style="margin-top:10px" class="hidden">
      <button id="openAbsenceModalBtn" class="btn btn-ghost">Choose absence reason</button>
      <div class="small" style="margin-top:6px;color:var(--muted)">If Absent, choose a reason next.</div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="attendanceCancelBtn" class="btn btn-ghost">Cancel</button>
      <button id="attendanceSaveBtn" class="btn btn-primary">Save</button>
    </div>
  </div>
</div>

<!-- Absence modal -->
<div id="absenceModal" class="modal">
  <div class="modal-card">
    <h3>Absence Reason</h3>
    <div style="margin-top:8px">
      <select id="absenceReasonSelect" class="input">
        <option value="Football">Football</option>
        <option value="Band">Band</option>
        <option value="Sick">Sick</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="absenceCancelBtn" class="btn btn-ghost">Cancel</button>
      <button id="absenceSaveBtn" class="btn btn-primary">Save Reason</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmModal" class="modal">
  <div class="modal-card">
    <h3 id="confirmTitle">Confirm</h3>
    <div id="confirmText" class="small" style="margin-top:8px"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button id="confirmNoBtn" class="btn btn-ghost">No</button>
      <button id="confirmYesBtn" class="btn btn-danger">Yes</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

<script>
/* ============================
   Firebase config — using your project
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyAACv92bzY5cECbECBtsw6oyxrUnEBaJMY",
  authDomain: "pg-theater-call-board.firebaseapp.com",
  projectId: "pg-theater-call-board",
  storageBucket: "pg-theater-call-board.appspot.com",
  messagingSenderId: "850857757575",
  appId: "1:850857757575:web:8b2f93e76b2cf008aea122",
  measurementId: "G-ELWLH31ZCJ"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============================
   Local USERS (provided accounts)
   ============================ */
const USERS = {
  lnewton:{password:"?2@2yzz~PVJf", name:"L. Newton", role:"Director"},
  tbeck:{password:"pHR68Db.Pw.#", name:"T. Beck", role:"Director"},
  gloshe:{password:"iT=hy!7G9NTf", name:"G. Loshe", role:"Director"},
  bflieder:{password:"-W9m=>D_AUzF", name:"B. Flieder", role:"Director"},
  cclark:{password:"iJ+va7>Df}#@", name:"C. Clark", role:"Director"},
  ljulien:{password:";3y2Paz9£9?m", name:"Logan Julien", role:"Stage Manager"},
  hflowers:{password:"i£08um?B51.x", name:"Haley Flowers", role:"Stage Manager"},
  nwalker:{password:"9^1~R7C*QVdV", name:"Natalie Walker", role:"Stage Manager"},
  apate:{password:"y~D+V3R-37Wt", name:"Annaston Pate", role:"Actor"},
  cbeck:{password:"G?5sLRCkZYCg", name:"C. Beck", role:"Actor"},
  sjulien:{password:"#0Y57gk*b?Jq", name:"S. Julien", role:"Actor"},
  agipson:{password:"c!?xGW2JvB:2", name:"A. Gipson", role:"Actor"},
  owyatt:{password:"9vq-B#4q]}>.", name:"O. Wyatt", role:"Actor"},
  swyatt:{password:"B?2jjtvNqtq_", name:"S. Wyatt", role:"Actor"},
  afry:{password:"5Mxc,kQpd,!T", name:"A. Fry", role:"Actor"},
  rromero:{password:"=4A*pq+xQq:!", name:"R. Romero", role:"Actor"},
  gromero:{password:"j.dab8,6X_m2", name:"G. Romero", role:"Actor"}
};

/* ============================
   State & helpers
   ============================ */
let currentUser = null;
let attendanceTarget = null;
let confirmCallback = null;
let unsubAnnouncements = null, unsubSchedule = null, unsubAttendance = null;

const q = id => document.getElementById(id);
function isSMorDirector(){ return currentUser && (currentUser.role === "Stage Manager" || currentUser.role === "Director"); }
function isDirector(){ return currentUser && currentUser.role === "Director"; }
function formatDate(ts){ return ts ? new Date(ts).toLocaleString() : ""; }

/* ============================
   Start realtime listeners
   ============================ */
function startRealtime(){
  unsubAnnouncements = db.collection("announcements").orderBy("time","desc")
    .onSnapshot(snap => { const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()})); renderAnnouncements(items); });

  unsubSchedule = db.collection("schedule").orderBy("date").orderBy("time")
    .onSnapshot(snap => { const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()})); renderSchedule(items); });

  unsubAttendance = db.collection("attendance")
    .onSnapshot(snap => { const map={}; snap.forEach(d=>map[d.id]=d.data()); renderAttendance(map); renderAttendanceReportLarge(map); });
}
function stopRealtime(){ unsubAnnouncements && unsubAnnouncements(); unsubSchedule && unsubSchedule(); unsubAttendance && unsubAttendance(); unsubAnnouncements=unsubSchedule=unsubAttendance=null; }

/* ============================
   Auth (local) — sign-in modal handling
   ============================ */
q("signinBtn").addEventListener("click", ()=> {
  const username = q("usernameInput").value.trim();
  const password = q("passwordInput").value;
  if(!username || !password){ alert("Enter credentials"); return; }
  const u = USERS[username];
  if(!u || u.password !== password){ alert("Invalid username/password"); return; }
  currentUser = { username, name: u.name, role: u.role };
  // hide full-screen signin
  document.getElementById("signinFullScreen").style.display = "none";
  document.getElementById("mainApp").style.visibility = "visible";
  q("signed-in-controls").classList.remove("hidden");
  q("signedInAs").textContent = `${currentUser.name} — ${currentUser.role}`;
  attachRoleUI();
  populateCallWho();
  startRealtime();
});

// optional cancel: hide modal but still keep app invisible — user can re-open later
q("signinCancelBtn").addEventListener("click", ()=> {
  // small convenience: do nothing except close modal (but app still hidden)
  document.getElementById("signinFullScreen").style.display = "none";
  // keep main app hidden to enforce sign-in usage:
  document.getElementById("mainApp").style.visibility = "hidden";
});

q("signoutBtn").addEventListener("click", ()=> {
  stopRealtime();
  currentUser = null;
  document.getElementById("signinFullScreen").style.display = "flex";
  document.getElementById("mainApp").style.visibility = "hidden";
  q("signed-in-controls").classList.add("hidden");
  q("signedInAs").textContent = "";
  clearUI();
});

/* ============================
   Role UI & populate select
   ============================ */
function attachRoleUI(){
  if(!currentUser) return;
  if(isSMorDirector()){
    q("toggleScheduleForm").classList.remove("hidden");
    q("toggleAnnForm").classList.remove("hidden");
    q("exportCsvBtn").classList.remove("hidden");
    document.querySelectorAll(".manageCol").forEach(el=>el.classList.remove("hidden"));
  } else {
    q("toggleScheduleForm").classList.add("hidden");
    q("toggleAnnForm").classList.add("hidden");
    q("exportCsvBtn").classList.add("hidden");
    document.querySelectorAll(".manageCol").forEach(el=>el.classList.add("hidden"));
  }
  if(isDirector()){ q("directorSummaryCard").classList.remove("hidden"); q("directorControls").classList.remove("hidden"); }
  else { q("directorSummaryCard").classList.add("hidden"); q("directorControls").classList.add("hidden"); }
}

function populateCallWho(){
  const sel = q("callWho"); sel.innerHTML = "";
  Object.keys(USERS).forEach(u => { if(USERS[u].role === "Actor"){ const opt = document.createElement("option"); opt.value = u; opt.textContent = USERS[u].name; sel.appendChild(opt); }});
}

/* ============================
   Schedule add/delete
   ============================ */
q("toggleScheduleForm").addEventListener("click", ()=> q("scheduleForm").classList.toggle("hidden"));
q("cancelCallBtn").addEventListener("click", ()=> q("scheduleForm").classList.add("hidden"));
q("addCallBtn").addEventListener("click", async ()=> {
  const date = q("callDate").value, time = q("callTime").value, details = q("callDetails").value.trim();
  const selected = Array.from(q("callWho").selectedOptions).map(o=>o.value);
  if(!date || !time || selected.length===0){ alert("Fill date/time and select at least one actor."); return; }
  await db.collection("schedule").add({ date, time, who:selected, details, createdBy: currentUser.username, createdAt: Date.now() });
  q("callDate").value=""; q("callTime").value=""; q("callDetails").value=""; q("callWho").selectedIndex=-1;
  q("scheduleForm").classList.add("hidden");
});

/* ============================
   Announcements add/delete
   ============================ */
q("toggleAnnForm").addEventListener("click", ()=> q("annForm").classList.toggle("hidden"));
q("cancelAnnBtn").addEventListener("click", ()=> q("annForm").classList.add("hidden"));
q("addAnnouncementBtn").addEventListener("click", async ()=> {
  const text = q("announcementText").value.trim(); if(!text){ alert("Enter announcement"); return; }
  await db.collection("announcements").add({ text, by: currentUser.username, time: Date.now() });
  q("announcementText").value=""; q("annForm").classList.add("hidden");
});

/* ============================
   Attendance modal flow (writes include status, reason, by, time)
   ============================ */
q("attendanceSaveBtn").addEventListener("click", async ()=> {
  if(!attendanceTarget){ alert("No actor selected"); return; }
  const status = q("attendanceSelect").value;
  if(status === "Absent"){ q("attendanceModal").style.display="none"; q("absenceModal").style.display="flex"; return; }
  await db.collection("attendance").doc(attendanceTarget).set({ status, reason:"", by: currentUser.username, time: Date.now() });
  q("attendanceModal").style.display="none";
});
q("attendanceCancelBtn").addEventListener("click", ()=> q("attendanceModal").style.display="none");
q("absenceSaveBtn").addEventListener("click", async ()=> {
  if(!attendanceTarget){ q("absenceModal").style.display="none"; return; }
  const reason = q("absenceReasonSelect").value || "Other";
  await db.collection("attendance").doc(attendanceTarget).set({ status:"Absent", reason, by: currentUser.username, time: Date.now() });
  q("absenceModal").style.display="none";
});
q("absenceCancelBtn").addEventListener("click", ()=> { q("absenceModal").style.display="none"; q("attendanceSelect").value="Present"; q("attendanceModal").style.display="flex"; });
document.addEventListener("click", (e)=>{ if(e.target && e.target.id === "openAbsenceModalBtn"){ q("absenceModal").style.display="flex"; q("attendanceModal").style.display="none"; }});
q("attendanceSelect").addEventListener("change", ()=> q("absenceLauncher").classList.toggle("hidden", q("attendanceSelect").value !== "Absent"));

/* ============================
   Quick mark helpers (include by & time)
   ============================ */
async function quickMarkPresent(u){ await db.collection("attendance").doc(u).set({ status:"Present", reason:"", by: currentUser.username, time: Date.now() }); }
async function quickMarkTardy(u){ await db.collection("attendance").doc(u).set({ status:"Tardy", reason:"", by: currentUser.username, time: Date.now() }); }
async function quickMarkLeftEarly(u){ await db.collection("attendance").doc(u).set({ status:"Left Early", reason:"", by: currentUser.username, time: Date.now() }); }
function quickMarkAbsentLauncher(u){ attendanceTarget = u; q("absenceReasonSelect").value="Football"; q("absenceModal").style.display="flex"; }

/* ============================
   Export CSV
   ============================ */
q("exportCsvBtn").addEventListener("click", async ()=> {
  const snap = await db.collection("attendance").get();
  let csv = "Name,Role,Status,Reason,Time,Marked By\n";
  snap.forEach(d=>{ const a=d.data(); const uname=d.id; csv += `"${USERS[uname]?.name || uname}","${USERS[uname]?.role || ''}","${a.status||''}","${a.reason||''}","${formatDate(a.time)||''}","${a.by||''}"\n`; });
  const blob = new Blob([csv], {type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="attendance.csv"; a.click(); URL.revokeObjectURL(url);
});

/* ============================
   Force mark (director)
   ============================ */
q("forceMarkBtn").addEventListener("click", async ()=> {
  if(!isDirector()) return alert("Directors only");
  if(!confirm("Mark all unmarked actors Present?")) return;
  const snap = await db.collection("attendance").get(); const present=new Set(); snap.forEach(d=>present.add(d.id));
  const ops=[]; Object.keys(USERS).forEach(u=>{ if(USERS[u].role==="Actor" && !present.has(u)) ops.push(db.collection("attendance").doc(u).set({ status:"Present", reason:"", by: currentUser.username, time: Date.now() })); });
  await Promise.all(ops); alert("Force-mark complete.");
});

/* ============================
   Confirm modal
   ============================ */
function showConfirm(title,text,cb){ q("confirmTitle").textContent=title; q("confirmText").textContent=text; q("confirmModal").style.display="flex"; confirmCallback=cb; }
q("confirmNoBtn").addEventListener("click", ()=>{ q("confirmModal").style.display="none"; confirmCallback=null; });
q("confirmYesBtn").addEventListener("click", ()=>{ q("confirmModal").style.display="none"; if(typeof confirmCallback==="function") confirmCallback(); confirmCallback=null; });

/* ============================
   Render functions
   ============================ */
function renderAnnouncements(items){
  const container = q("announcementsList"); container.innerHTML="";
  if(!items.length){ container.innerHTML = `<div class="small">No announcements.</div>`; return; }
  items.forEach(a=>{
    const row = document.createElement("div"); row.className="entry-row";
    const left = document.createElement("div"); left.innerHTML = `<div style="font-weight:700">${a.text}</div><div class="small-muted">Posted ${formatDate(a.time)} by ${USERS[a.by]?.name || a.by}</div>`;
    const right = document.createElement("div");
    if(isSMorDirector()){
      const del = document.createElement("button"); del.className="btn btn-danger btn-sm"; del.textContent="Delete";
      del.addEventListener("click", ()=> showConfirm("Delete Announcement","Delete this announcement?", async ()=> await db.collection("announcements").doc(a.id).delete()));
      right.appendChild(del);
    }
    row.appendChild(left); row.appendChild(right); container.appendChild(row);
  });
}

function renderSchedule(items){
  const container = q("scheduleList"); container.innerHTML="";
  if(!items.length){ container.innerHTML = `<div class="small">No calls scheduled.</div>`; return; }
  items.sort((A,B)=> new Date(A.date + " " + A.time) - new Date(B.date + " " + B.time));
  items.forEach(s=>{
    if(currentUser.role === "Actor" && !s.who.includes(currentUser.username)) return;
    const row = document.createElement("div"); row.className="entry-row";
    const left = document.createElement("div"); left.innerHTML = `<div style="font-weight:700">${s.date} ${s.time}</div><div class="small-muted">${s.details}</div>`;
    const whoNames = s.who.map(u=>USERS[u]?.name || u).join(", ");
    const right = document.createElement("div"); right.innerHTML = `<div class="small-muted">Called: ${whoNames}</div>`;
    if(isSMorDirector()){
      const del = document.createElement("button"); del.className="btn btn-danger btn-sm"; del.textContent="Delete";
      del.addEventListener("click", ()=> showConfirm("Delete Call","Delete this call?", async ()=> await db.collection("schedule").doc(s.id).delete()));
      right.appendChild(del);
    }
    row.appendChild(left); row.appendChild(right); container.appendChild(row);
  });
  renderDirectorSummaryFromSchedule(items);
}

function renderAttendance(map){
  const tbody = q("attendanceList"); tbody.innerHTML = "";
  Object.keys(USERS).forEach(u=>{
    if(USERS[u].role !== "Actor") return;
    if(currentUser.role === "Actor" && currentUser.username !== u) return;
    const a = map[u];
    const status = a ? a.status : "Not Marked";
    const reason = a && a.reason ? a.reason : "";
    const timeStr = a && a.time ? formatDate(a.time) : "";
    const byName = a && a.by ? (USERS[a.by] ? USERS[a.by].name : a.by) : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${USERS[u].name}</td><td>${status}</td><td class="col-wrap">${reason}</td><td>${timeStr}</td><td>${byName}</td>`;
    const tdActions = document.createElement("td");
    const markBtn = document.createElement("button"); markBtn.className="btn btn-ghost btn-sm"; markBtn.textContent="Mark";
    markBtn.addEventListener("click", ()=>{ attendanceTarget = u; q("attendanceSelect").value = a ? a.status : "Present"; q("absenceLauncher").classList.toggle("hidden", q("attendanceSelect").value !== "Absent"); q("attendanceModal").style.display="flex"; });
    tdActions.appendChild(markBtn);
    if(isSMorDirector()){
      const pBtn = document.createElement("button"); pBtn.className="btn btn-primary btn-sm"; pBtn.textContent="P"; pBtn.style.marginLeft="6px"; pBtn.addEventListener("click", ()=> quickMarkPresent(u));
      const aBtn = document.createElement("button"); aBtn.className="btn btn-danger btn-sm"; aBtn.textContent="A"; aBtn.style.marginLeft="6px"; aBtn.addEventListener("click", ()=> quickMarkAbsentLauncher(u));
      const tBtn = document.createElement("button"); tBtn.className="btn btn-sm"; tBtn.textContent="T"; tBtn.style.marginLeft="6px"; tBtn.addEventListener("click", ()=> quickMarkTardy(u));
      const lBtn = document.createElement("button"); lBtn.className="btn btn-sm"; lBtn.textContent="L"; lBtn.style.marginLeft="6px"; lBtn.addEventListener("click", ()=> quickMarkLeftEarly(u));
      tdActions.appendChild(pBtn); tdActions.appendChild(aBtn); tdActions.appendChild(tBtn); tdActions.appendChild(lBtn);
    }
    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
}

/* Render LARGE attendance report on the left (bigger and left-shifted) */
function renderAttendanceReportLarge(map){
  const container = q("attendanceReportLargeInner");
  // only show for SM/Director
  if(!isSMorDirector()){ container.innerHTML = `<div class="small-muted">Sign in as Stage Manager or Director to view full report.</div>`; return; }
  // build table
  const table = document.createElement("table");
  table.className = "table";
  const thead = document.createElement("tr");
  ["Name","Role","Status","Reason","Time","Marked By"].forEach(h=>{ const th=document.createElement("th"); th.textContent = h; thead.appendChild(th); });
  table.appendChild(thead);
  Object.keys(USERS).forEach(u=>{
    if(USERS[u].role !== "Actor") return;
    const a = map[u];
    const tr = document.createElement("tr");
    const cells = [
      USERS[u].name,
      USERS[u].role,
      a ? a.status : "Not Marked",
      a ? (a.reason || "") : "",
      a ? formatDate(a.time) : "",
      a ? (USERS[a.by] ? USERS[a.by].name : a.by) : ""
    ];
    cells.forEach(c=>{ const td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
    table.appendChild(tr);
  });
  container.innerHTML = ""; container.appendChild(table);
}

function renderAttendanceReportFromMap(map){
  const container = q("attendanceReport"); container.innerHTML = "<h3>Attendance Report</h3>";
  const table = document.createElement("table"); table.className="table";
  const thead = document.createElement("tr");
  ["Name","Role","Status","Reason","Time","Marked By"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; thead.appendChild(th); });
  table.appendChild(thead);
  Object.keys(USERS).forEach(u=>{
    const a = map[u];
    const tr = document.createElement("tr");
    const cells = [USERS[u].name, USERS[u].role, a ? a.status : "Not Marked", a ? (a.reason || "") : "", a ? formatDate(a.time) : "", a ? (USERS[a.by] ? USERS[a.by].name : a.by) : "" ];
    cells.forEach(c=>{ const td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
    table.appendChild(tr);
  });
  container.appendChild(table);
}

function renderDirectorSummaryFromSchedule(items){
  const list = q("nextCallsList"); list.innerHTML = "";
  if(!isDirector()){ q("directorSummaryCard").classList.add("hidden"); return; }
  q("directorSummaryCard").classList.remove("hidden");
  const upcoming = (items || []).slice().sort((a,b)=> new Date(a.date + " " + a.time) - new Date(b.date + " " + b.time)).slice(0,6);
  if(upcoming.length === 0){ list.textContent = "No upcoming calls."; return; }
  upcoming.forEach(s=>{
    const el = document.createElement("div");
    const whoNames = s.who.map(u => USERS[u]?.name || u).join(", ");
    el.innerHTML = `<div style="font-weight:700">${s.date} ${s.time} — ${whoNames}</div><div class="small-muted">${s.details}</div>`;
    list.appendChild(el);
  });
}

/* ============================
   UI cleanup on signout
   ============================ */
function clearUI(){
  q("announcementsList").innerHTML = ""; q("scheduleList").innerHTML = ""; q("attendanceList").innerHTML = ""; q("attendanceReportLargeInner").innerHTML = "Sign in to view report."; q("attendanceReport").innerHTML = "";
  q("nextCallsList").innerHTML = "";
  q("scheduleForm").classList.add("hidden"); q("annForm").classList.add("hidden");
  q("directorSummaryCard").classList.add("hidden"); q("directorControls").classList.add("hidden");
  q("toggleScheduleForm").classList.add("hidden"); q("toggleAnnForm").classList.add("hidden"); q("exportCsvBtn").classList.add("hidden");
}

/* ============================
   Modal helpers & keyboard
   ============================ */
document.querySelectorAll(".modal").forEach(m=> m.addEventListener("click", (e)=> { if(e.target===m) m.style.display="none"; } ));
document.addEventListener("keydown", (e)=> { if(e.key === "Escape") document.querySelectorAll(".modal").forEach(m=> m.style.display="none"); });

/* ============================
   Startup: populate actor select
   ============================ */
(function startup(){ populateCallWho(); })();
</script>
</body>
</html>