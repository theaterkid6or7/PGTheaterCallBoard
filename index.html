<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PG Theater Call Board</title>
<style>
  /* ========= BODY & GENERAL ========= */
  body { margin:0; font-family:Arial,sans-serif; background:#0d0d0d; color:#FFD700; }
  .header { display:flex; justify-content:space-between; align-items:center; background:#111; padding:12px 24px; border-bottom:2px solid #FFD700; }
  .header h1 { margin:0; font-size:1.5rem; color:#FFD700; }
  #clock { font-size:1rem; color:#fff; }
  button { padding:6px 12px; margin:2px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; transition:0.2s; }
  button:hover { opacity:0.8; }
  .btn-ghost { background:none; color:#FFD700; border:1px solid #FFD700; }
  .container { padding:24px; max-width:1200px; margin:auto; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { border:1px solid #FFD700; padding:8px; text-align:center; font-size:0.9rem; }
  th { background:#222; }
  td { background:#111; }
  input, select, textarea { padding:6px; margin:2px; border-radius:4px; border:1px solid #FFD700; background:#0d0d0d; color:#FFD700; }
  textarea { resize:none; }
  #loginScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
  #loginScreen input { margin:6px; width:200px; }
  #mainBoard { display:none; }
  .attendance-button { margin:2px; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem; }
  .present { background:#00FF00; color:#000; }
  .absent { background:#FF0000; color:#fff; }
  .tardy { background:#FFD700; color:#000; }
  .left { background:#555; color:#fff; }
  .announcement { border:1px solid #FFD700; padding:8px; margin-bottom:6px; background:#111; }
  .hover-highlight:hover { background:#333; }
  .section-title { font-size:1.2rem; margin-top:24px; margin-bottom:12px; border-bottom:1px solid #FFD700; padding-bottom:4px; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  .form-inline input, .form-inline button { margin-right:6px; }
  /* Scrollable attendance table if large */
  #attendanceWrapper { max-height:300px; overflow-y:auto; margin-bottom:12px; border:1px solid #FFD700; }
  /* Show Mode cues table */
  #cuesTable th, #cuesTable td { font-size:0.85rem; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

// ================= Firebase Config =================
const firebaseConfig = {
  apiKey: "AIzaSyAACv92bzY5cECbECBtsw6oyxrUnEBaJMY",
  authDomain: "pg-theater-call-board.firebaseapp.com",
  databaseURL: "https://pg-theater-call-board-default-rtdb.firebaseio.com",
  projectId: "pg-theater-call-board",
  storageBucket: "pg-theater-call-board.firebasestorage.app",
  messagingSenderId: "850857757575",
  appId: "1:850857757575:web:8b2f93e76b2cf008aea122",
  measurementId: "G-ELWLH31ZCJ"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================= User Accounts =================
const accounts = {
  lnewton:{password:"?2@2yzz~PVJf", role:"Director"},
  tbeck:{password:"pHR68Db.Pw.#", role:"AD/Coreography"},
  gloshe:{password:"iT=hy!7G9NTf", role:"Tech Director"},
  bflieder:{password:"-W9m=>D_AUzF", role:"ATD/Hair Guru"},
  cclark:{password:"iJ+va7>Df}#@", role:"SATD"},
  ljulien:{password:";3y2Paz9£9?m", role:"Stage Manager"},
  hflowers:{password:"i£08um?B51.x", role:"Stage Manager"},
  nwalker:{password:"9^1~R7C*QVdV", role:"Stage Manager"},
  apate:{password:"y~D+V3R-37Wt", role:"Actor"},
  cbeck:{password:"G?5sLRCkZYCg", role:"Actor"},
  sjulien:{password:"#0Y57gk*b?Jq", role:"Actor"},
  agipson:{password:"c!?xGW2JvB:2", role:"Actor"},
  owyatt:{password:"9vq-B#4q]}>.", role:"Actor"},
  swyatt:{password:"B?2jjtvNqtq_", role:"Actor"},
  afry:{password:"5Mxc,kQpd,!T", role:"Actor"},
  rromero:{password:"=4A*pq+xQq:!", role:"Actor"},
  gromero:{password:"j.dab8,6X_m2", role:"Actor"}
};

let currentUser = null;

// ================= DOM Elements =================
const loginScreen = document.getElementById("loginScreen");
const mainBoard = document.getElementById("mainBoard");
const loginForm = document.getElementById("loginForm");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const signedInAs = document.getElementById("signedInAs");
const showModeBtn = document.getElementById("showModeBtn");
const attendanceTable = document.getElementById("attendanceTable").getElementsByTagName('tbody')[0];
const announcementsDiv = document.getElementById("announcements");
const cuesTable = document.getElementById("cuesTable").getElementsByTagName('tbody')[0];

// ================= Clock =================
function updateCSTClock(){
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset()*60000);
  const offset = -6; // CST
  const cst = new Date(utc + (3600000*offset));
  let hours = cst.getHours();
  const minutes = cst.getMinutes();
  const ampm = hours>=12?"PM":"AM";
  hours = hours%12; if(hours===0) hours=12;
  const minStr = minutes<10?'0'+minutes:minutes;
  document.getElementById("clock").textContent = `CST ${hours}:${minStr} ${ampm}`;
}
setInterval(updateCSTClock,1000);
updateCSTClock();

// ================= Login Handler =================
loginForm.addEventListener("submit", e=>{
  e.preventDefault();
  const user=usernameInput.value;
  const pass=passwordInput.value;
  if(accounts[user] && accounts[user].password===pass){
    currentUser = {name:user, role:accounts[user].role};
    loginScreen.style.display="none";
    mainBoard.style.display="block";
    signedInAs.textContent = `Signed in as: ${currentUser.name} (${currentUser.role})`;

    // Only show Show Mode button for Stage Managers and Directors
    if(currentUser.role==="Stage Manager" || currentUser.role==="Director"){
      showModeBtn.style.display="inline-block";
    }

    renderAttendance();
    renderAnnouncements();
    renderCues();
  }else{ alert("Invalid username or password"); }
});

// ================= Attendance Functions =================
function renderAttendance(){
  onValue(ref(db,'attendance'), snapshot=>{
    attendanceTable.innerHTML="";
    snapshot.forEach(snap=>{
      const data = snap.val();
      const id = snap.key;
      const row = attendanceTable.insertRow();
      row.insertCell(0).textContent = data.name;
      row.insertCell(1).textContent = data.status;
      const btnCell = row.insertCell(2);
      ["Present","Absent","Tardy","Left Early","Football","Band","Sick","Other"].forEach(s=>{
        const btn=document.createElement("button");
        btn.textContent=s;
        btn.className="attendance-button";
        btn.addEventListener("click", ()=>{
          // Actors can only update themselves, SMs/Directors can update all
          if(currentUser.role.includes("Stage Manager") || currentUser.role==="Director" || currentUser.name===data.name){
            update(ref(db,'attendance/'+id),{status:s});
          }else{
            alert("You cannot update other people's attendance.");
          }
        });
        btnCell.appendChild(btn);
      });
    });
  });
}
document.getElementById("addAttendanceForm").addEventListener("submit", e=>{
  e.preventDefault();
  const name=document.getElementById("newName").value;
  if(!name) return;
  const newRef=push(ref(db,'attendance'));
  set(newRef,{name:name,status:"Present"});
  document.getElementById("newName").value="";
});

// ================= Announcements Functions =================
function renderAnnouncements(){
  onValue(ref(db,'announcements'), snapshot=>{
    announcementsDiv.innerHTML="";
    snapshot.forEach(snap=>{
      const data=snap.val();
      const div=document.createElement("div");
      div.className="announcement";
      div.textContent=`[${data.time}] ${data.by}: ${data.text}`;
      announcementsDiv.appendChild(div);
    });
  });
}
document.getElementById("addAnnouncementForm").addEventListener("submit", e=>{
  e.preventDefault();
  const text=document.getElementById("announcementText").value;
  if(!text) return;
  const now=new Date();
  const time=`${now.getHours()}:${now.getMinutes()<10?'0':''}${now.getMinutes()}`;
  const newRef=push(ref(db,'announcements'));
  set(newRef,{by:currentUser.name,time:time,text:text});
  document.getElementById("announcementText").value="";
});

// ================= Show Mode (Cues) Functions =================
function renderCues(){
  onValue(ref(db,'cues'), snapshot=>{
    cuesTable.innerHTML="";
    snapshot.forEach(snap=>{
      const data = snap.val();
      const id = snap.key;
      const row = cuesTable.insertRow();
      row.insertCell(0).textContent = data.number;
      row.insertCell(1).textContent = data.department;
      row.insertCell(2).textContent = data.action;
      row.insertCell(3).textContent = data.status;
      const btnCell = row.insertCell(4);

      // Only Stage Managers and Directors can control cues
      if(currentUser.role.includes("Stage Manager") || currentUser.role==="Director"){
        ["Standby","Go","Reset"].forEach(cmd=>{
          const btn = document.createElement("button");
          btn.textContent = cmd;
          btn.className="attendance-button";
          btn.addEventListener("click", ()=>{
            update(ref(db,'cues/'+id),{status:cmd,markedBy:currentUser.name});
          });
          btnCell.appendChild(btn);
        });
      } else {
        btnCell.textContent = "N/A";
      }
    });
  });
}
document.getElementById("addCueForm").addEventListener("submit", e=>{
  e.preventDefault();
  const num = document.getElementById("cueNumber").value;
  const dept = document.getElementById("cueDept").value;
  const action = document.getElementById("cueAction").value;
  if(!num || !dept || !action) return;
  const newRef = push(ref(db,'cues'));
  set(newRef,{number:num,department:dept,action:action,status:"Standby",markedBy:""});
  document.getElementById("cueNumber").value="";
  document.getElementById("cueDept").value="";
  document.getElementById("cueAction").value="";
});
</script>
</head>
<body>
<div class="header">
  <h1>PG Theater Call Board</h1>
  <div id="clock"></div>
  <button id="showModeBtn" onclick="window.location.href='showmode.html'" class="btn btn-ghost" style="display:none;">Go to Show Mode</button>
  <div id="signedInAs"></div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <h2>Sign In</h2>
  <form id="loginForm">
    <input id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="btn">Sign In</button>
  </form>
</div>

<!-- MAIN BOARD -->
<div id="mainBoard">
  <div class="container">
    <!-- ATTENDANCE -->
    <div class="section-title">Attendance</div>
    <div id="attendanceWrapper">
      <table id="attendanceTable">
        <thead><tr><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <form id="addAttendanceForm" class="form-inline">
      <input id="newName" placeholder="Add Person" required>
      <button type="submit" class="btn">Add</button>
    </form>

    <!-- ANNOUNCEMENTS -->
    <div class="section-title">Announcements</div>
    <div id="announcements"></div>
    <form id="addAnnouncementForm" class="form-inline">
      <input id="announcementText" placeholder="New announcement" required style="width:70%;">
      <button type="submit" class="btn">Post</button>
    </form>

    <!-- SHOW MODE (CUES) -->
    <div class="section-title">Show Mode Cues</div>
    <div id="cuesWrapper">
      <table id="cuesTable">
        <thead><tr><th>#</th><th>Dept</th><th>Action</th><th>Status</th><th>Control</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <form id="addCueForm" class="form-inline">
      <input id="cueNumber" placeholder="Cue #" required>
      <input id="cueDept" placeholder="Dept (Lights/Sound/Set)" required>
      <input id="cueAction" placeholder="Action" required>
      <button type="submit" class="btn">Add Cue</button>
    </form>
  </div>
</div>
</body>
</html>